<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ruta Comercial GT v9</title>
    <style>
        /* ESTILOS BASE */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f2f4f8; margin: 0; padding: 0; padding-bottom: 80px; }
        
        header { background-color: #0d47a1; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 12px; border: 1px solid #e1e4e8; }
        
        h3 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; font-size: 1.1em; }
        label { font-weight: 600; font-size: 0.85em; color: #5f6368; display: block; margin-top: 12px; }
        
        /* Inputs */
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; background-color: #fff; height: 45px; }
        
        /* BOTONES */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: bold; margin-top: 15px; color: white; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: #1976d2; }
        .btn-success { background-color: #2e7d32; }
        .btn-secondary { background-color: #757575; }
        .btn-warning { background-color: #fbc02d; color: #333; }
        .btn-danger { background-color: #d32f2f; }
        .btn-dark { background-color: #263238; }
        .btn-info { background-color: #0288d1; }

        /* Botones Peque√±os */
        .btn-icon { padding: 6px 10px; border-radius: 4px; border: none; cursor: pointer; color: white; margin-left: 2px; font-size: 14px; }
        
        /* Checkbox */
        .check-ruta { width: 24px; height: 24px; margin-right: 12px; vertical-align: middle; accent-color: #1976d2; }

        /* MEN√ö INFERIOR */
        .nav-bar { display: flex; justify-content: space-around; background: white; padding: 8px 0; position: fixed; bottom: 0; width: 100%; border-top: 1px solid #ddd; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .nav-btn { background: none; border: none; color: #5f6368; font-size: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; width: 25%; }
        .nav-btn.active { color: #1565c0; font-weight: bold; }
        .nav-icon { font-size: 22px; margin-bottom: 2px; }
        .badge { background: #d32f2f; color: white; border-radius: 50%; padding: 3px 6px; font-size: 10px; position: absolute; top: 2px; right: 20%; font-weight: bold; }

        /* ETIQUETAS */
        .tag-visited { background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; border: 1px solid #c8e6c9; display: inline-block; margin-top: 5px; }
        .tag-dept { background: #e3f2fd; color: #1565c0; padding: 3px 6px; border-radius: 4px; font-size: 0.75em; font-weight: bold; text-transform: uppercase; }

        /* TABLA REPORTES */
        table { width: 100%; border-collapse: collapse; font-size: 0.8em; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f5f5f5; font-weight: bold; color: #333; }
        .hidden { display: none !important; }

        /* Checkboxes de contacto */
        .contact-options { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .contact-option { display: flex; align-items: center; gap: 5px; }
        .contact-option input[type="checkbox"] { width: 20px; height: 20px; }
        .contact-label { font-size: 0.85em; color: #333; }

        /* Colores para las opciones de contacto */
        .whatsapp-option { color: #25D366; }
        .call-option { color: #4285F4; }
        .other-option { color: #757575; }

        /* Buscador */
        .search-container { position: relative; margin-top: 10px; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666; }
        .search-input { padding-left: 35px !important; }

        /* Indicador de optimizaci√≥n */
        .route-optimized { background: #e8f5e9 !important; border-left: 5px solid #2e7d32 !important; }
        .route-distance { font-size: 0.8em; color: #666; margin-left: 5px; }

        @media print {
            .no-print, .nav-bar, header { display: none !important; }
            .card { box-shadow: none; border: none; padding: 0; margin: 0; }
            body { background: white; padding: 0; }
        }
    </style>
</head>
<body>

    <header class="no-print">
        <span style="font-weight:bold;">Ruta Comercial GT</span>
        <button class="btn-icon btn-warning" onclick="limpiarRuta()" style="font-size:11px; padding:5px; color:black; font-weight:bold;">Limpiar Ruta</button>
    </header>

    <div class="container">

        <div id="view-dashboard" class="view-section">
            <button class="btn btn-primary" onclick="nuevoCliente()">+ AGREGAR CLIENTE NUEVO</button>
            
            <div class="card" style="margin-top:15px;">
                <h3>Cartera de Clientes</h3>
                
                <label style="margin-top:0;">Filtrar por Departamento:</label>
                <select id="filtroDeptDash" onchange="renderDashboard()">
                    <option value="">Mostrar Todos</option>
                </select>
                
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="buscadorDashboard" class="search-input" placeholder="Buscar por negocio, tel√©fono o encargado..." oninput="renderDashboard()">
                </div>

                <div id="listaClientes" style="margin-top:15px;"></div>
                <p id="msgVacio" style="text-align:center; color:#777; padding:20px; display:none;">No hay clientes registrados.</p>
            </div>
        </div>

        <div id="view-ruta" class="view-section hidden">
            <div class="card" style="background:#e3f2fd; border:1px solid #90caf9;">
                <h3 style="color:#1565c0; border:none;">üìç Ruta del D√≠a</h3>
                <p id="txtRuta" style="font-size:0.9em; color:#555;">Selecciona clientes en el inicio para armar tu ruta.</p>
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-primary" style="background:#0277bd; flex: 1;" onclick="abrirMapaRuta()">üó∫Ô∏è Abrir Ruta en Google Maps</button>
                    <button class="btn btn-success" style="flex: 1;" onclick="optimizarRuta()">üî¢ Optimizar Ruta por Proximidad</button>
                </div>
                
                <div style="margin-top: 10px; font-size: 0.8em; color: #666;">
                    <span id="rutaInfo">0 clientes en ruta</span>
                    <span id="distanciaTotal" style="margin-left: 10px;"></span>
                </div>
            </div>
            <div id="listaRutaContainer"></div>
        </div>

        <div id="view-form" class="view-section hidden">
            <div class="card">
                <h3 id="tituloForm">Datos Cliente</h3>
                <input type="hidden" id="idCliente">
                <input type="hidden" id="flagRuta" value="0">
                
                <label>Negocio / Cliente *</label>
                <input type="text" id="negocio" placeholder="Nombre del local">

                <label>Departamento *</label>
                <select id="departamento">
                    <!-- Los departamentos se cargar√°n con JavaScript -->
                </select>

                <label>Direcci√≥n (Referencia)</label>
                <input type="text" id="direccion" placeholder="Ej: Frente al parque...">

                <label>Encargado</label>
                <input type="text" id="encargado">

                <label>Tel√©fono * (8 d√≠gitos)</label>
                <input type="tel" id="telefono" maxlength="8" pattern="[0-9]{8}" placeholder="12345678" 
                       oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,8)">
                
                <label>Opciones de Contacto</label>
                <div class="contact-options">
                    <div class="contact-option whatsapp-option">
                        <input type="checkbox" id="contactoWhatsApp" value="whatsapp">
                        <label class="contact-label" for="contactoWhatsApp">WhatsApp</label>
                    </div>
                    <div class="contact-option call-option">
                        <input type="checkbox" id="contactoLlamada" value="llamada">
                        <label class="contact-label" for="contactoLlamada">Llamada</label>
                    </div>
                    <div class="contact-option other-option">
                        <input type="checkbox" id="contactoOtro" value="otro">
                        <label class="contact-label" for="contactoOtro">Otro</label>
                    </div>
                </div>

                <label>Mensaje para WhatsApp</label>
                <input type="text" id="mensajeWhatsApp" placeholder="Mensaje personalizado (opcional)">
                
                <label>Pr√≥xima Cita / Recordatorio</label>
                <input type="datetime-local" id="cita">
                
                <label>Opciones de Contacto para la Cita</label>
                <div class="contact-options">
                    <div class="contact-option whatsapp-option">
                        <input type="checkbox" id="citaWhatsApp" value="whatsapp">
                        <label class="contact-label" for="citaWhatsApp">Recordatorio por WhatsApp</label>
                    </div>
                    <div class="contact-option call-option">
                        <input type="checkbox" id="citaLlamada" value="llamada">
                        <label class="contact-label" for="citaLlamada">Recordatorio por Llamada</label>
                    </div>
                    <div class="contact-option other-option">
                        <input type="checkbox" id="citaOtro" value="otro">
                        <label class="contact-label" for="citaOtro">Otro m√©todo</label>
                    </div>
                </div>

                <button class="btn btn-warning" onclick="agendarCal()">üìÖ Agendar en Calendar</button>

                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn btn-secondary" onclick="volver()">Cancelar</button>
                    <button class="btn btn-primary" onclick="irGPS()">Siguiente ‚û°Ô∏è</button>
                </div>
            </div>
        </div>

        <div id="view-gps" class="view-section hidden">
            <div class="card">
                <h3>Ubicaci√≥n y Foto</h3>
                <button class="btn btn-primary" onclick="obtenerGPS()">üì° Obtener GPS</button>
                <p id="gpsTxt" style="font-size:0.9em; margin-top:5px; color:#555; font-weight:bold;">Esperando...</p>
                <input type="hidden" id="lat"><input type="hidden" id="lng">
                
                <div id="boxManual" class="hidden" style="margin-top:10px;">
                    <input type="text" id="linkMan" placeholder="Pegar link de Maps aqu√≠">
                    <button class="btn btn-secondary" onclick="usarManual()">Usar Link</button>
                </div>
                <hr>
                <label>Foto Evidencia</label>
                <div style="background:#eee; padding:5px; font-size:0.8em; border-radius:4px; margin-bottom:5px;">‚ÑπÔ∏è Se descargar√° con nombre del Depto y Fecha.</div>
                <input type="file" id="foto" accept="image/*" capture="environment">

                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn btn-secondary" onclick="mostrar('view-form')">‚¨ÖÔ∏è Volver</button>
                    <button class="btn btn-success" id="btnFin" onclick="guardar()">üíæ FINALIZAR</button>
                </div>
            </div>
        </div>

        <div id="view-reportes" class="view-section hidden">
            <div class="card no-print">
                <h3>Generador de Reportes</h3>
                <p style="font-size:0.9em; color:#555;">Selecciona el informe:</p>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" style="flex: 1;" onclick="reporteDiario()">üìÑ REPORTE VISITAS DEL D√çA</button>
                    <button class="btn btn-dark" style="flex: 1;" onclick="reporteTotal()">üìÇ CARTERA TOTAL DE CLIENTES</button>
                    <button class="btn btn-info" style="flex: 1;" onclick="exportarCSV()">üì• EXPORTAR A CSV</button>
                </div>
                
                <hr style="margin:20px 0;">
                
                <label>Filtros Manuales:</label>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="repFecha">
                    <select id="filtroDeptReporte">
                        <option value="">Todo Depto</option>
                        <!-- Los departamentos se cargar√°n con JavaScript -->
                    </select>
                </div>
                <button class="btn btn-primary" onclick="reporteCustom()">üîç Buscar</button>
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                    <label>Eliminar Registros del Reporte Actual:</label>
                    <button class="btn btn-danger" onclick="eliminarTodosDelReporte()" style="margin-top: 10px;">
                        üóëÔ∏è ELIMINAR TODOS LOS REGISTROS VISIBLES
                    </button>
                    <p style="font-size: 0.8em; color: #d32f2f; margin-top: 5px;">
                        ‚ö†Ô∏è Esta acci√≥n eliminar√° permanentemente todos los clientes mostrados en la tabla.
                    </p>
                </div>
            </div>

            <div class="card" id="areaPrint">
                <div style="text-align:center; margin-bottom:15px;">
                    <h2 id="tituloReporte" style="margin:0; color:#333;">REPORTE</h2>
                    <p id="subtituloReporte" style="margin:0; font-size:0.9em; color:#666;"></p>
                </div>

                <div style="overflow-x:auto;">
                    <table id="tablaRep">
                        <thead>
                            <tr style="background:#eee;">
                                <th>Cliente</th>
                                <th>Ubicaci√≥n / Contacto</th>
                                <th>Preferencias</th>
                                <th>Gesti√≥n</th>
                                <th class="no-print">Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="resumenReporte" style="margin-top:15px; font-weight:bold; text-align:right;"></div>
            </div>

            <div class="no-print" style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è IMPRIMIR / PDF</button>
                <button class="btn btn-info" onclick="exportarCSV()">üì• EXPORTAR A CSV</button>
            </div>
        </div>

    </div>

    <div class="nav-bar no-print">
        <button class="nav-btn active" id="btn-home" onclick="mostrar('view-dashboard')"><span class="nav-icon">üè†</span>Inicio</button>
        <button class="nav-btn" id="btn-ruta" onclick="mostrar('view-ruta')"><span class="nav-icon">üöö</span>Ruta<span id="badge" class="badge hidden">0</span></button>
        <button class="nav-btn" id="btn-add" onclick="nuevoCliente()"><span class="nav-icon">‚ûï</span>Crear</button>
        <button class="nav-btn" id="btn-rep" onclick="mostrar('view-reportes')"><span class="nav-icon">üìä</span>Reportes</button>
    </div>

    <script>
        // --- BASE DE DATOS DE DEPARTAMENTOS ---
        const LISTA_DEPARTAMENTOS = [
            "Alta Verapaz", "Baja Verapaz", "Chimaltenango", "Chiquimula", "El Progreso", 
            "Escuintla", "Guatemala", "Huehuetenango", "Izabal", "Jalapa", "Jutiapa", 
            "Pet√©n", "Quetzaltenango", "Quich√©", "Retalhuleu", "Sacatep√©quez", "San Marcos", 
            "Santa Rosa", "Solol√°", "Suchitep√©quez", "Totonicap√°n", "Zacapa"
        ];

        let db = JSON.parse(localStorage.getItem('db_clientes_v9')) || [];
        let ruta = JSON.parse(localStorage.getItem('db_ruta_v9')) || [];
        let filtrosReporteActual = { tipo: '', fecha: null, depto: null };
        let rutaOptimizada = false;
        let ubicacionActual = null;

        // --- INICIALIZACI√ìN ---
        document.addEventListener("DOMContentLoaded", () => {
            cargarDepartamentosEnSelects();
            renderDashboard();
            actualizarBadge();
            
            // Configurar fecha actual en el filtro de reportes
            document.getElementById('repFecha').value = new Date().toISOString().split('T')[0];
        });

        // FUNCI√ìN PARA CARGAR DEPARTAMENTOS EN TODOS LOS SELECT
        function cargarDepartamentosEnSelects() {
            // Cargar en el formulario principal
            const selectDepto = document.getElementById('departamento');
            selectDepto.innerHTML = '<option value="">Seleccionar Departamento</option>';
            LISTA_DEPARTAMENTOS.forEach(depto => {
                const option = document.createElement('option');
                option.value = depto;
                option.textContent = depto;
                selectDepto.appendChild(option);
            });
            selectDepto.value = "Guatemala"; // Valor por defecto

            // Cargar en el filtro del dashboard
            const filtroDash = document.getElementById('filtroDeptDash');
            filtroDash.innerHTML = '<option value="">Mostrar Todos</option>';
            LISTA_DEPARTAMENTOS.forEach(depto => {
                const option = document.createElement('option');
                option.value = depto;
                option.textContent = depto;
                filtroDash.appendChild(option);
            });

            // Cargar en el filtro de reportes
            const filtroReporte = document.getElementById('filtroDeptReporte');
            filtroReporte.innerHTML = '<option value="">Todo Depto</option>';
            LISTA_DEPARTAMENTOS.forEach(depto => {
                const option = document.createElement('option');
                option.value = depto;
                option.textContent = depto;
                filtroReporte.appendChild(option);
            });
        }

        // --- NAVEGACI√ìN ---
        function mostrar(id) {
            document.querySelectorAll('.view-section').forEach(x => x.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
            
            if(id=='view-dashboard') {
                document.getElementById('btn-home').classList.add('active');
                renderDashboard();
            }
            if(id=='view-ruta') { 
                document.getElementById('btn-ruta').classList.add('active'); 
                renderRuta(); 
            }
            if(id=='view-form') document.getElementById('btn-add').classList.add('active');
            if(id=='view-reportes') {
                document.getElementById('btn-rep').classList.add('active');
            }
        }
        
        function volver() {
            if(document.getElementById('flagRuta').value == '1') mostrar('view-ruta');
            else mostrar('view-dashboard');
        }

        // --- DASHBOARD CON BUSCADOR ---
        function renderDashboard() {
            const list = document.getElementById('listaClientes');
            const filtroDepto = document.getElementById('filtroDeptDash').value;
            const busqueda = document.getElementById('buscadorDashboard').value.toLowerCase();
            const hoy = new Date().toISOString().split('T')[0];
            list.innerHTML = '';

            // Filtrar por departamento si se ha seleccionado uno
            let data = [...db];
            
            if(filtroDepto) {
                data = data.filter(c => c.departamento === filtroDepto);
            }
            
            // Aplicar b√∫squeda si hay texto
            if(busqueda) {
                data = data.filter(c => 
                    (c.negocio && c.negocio.toLowerCase().includes(busqueda)) ||
                    (c.telefono && c.telefono.includes(busqueda)) ||
                    (c.encargado && c.encargado.toLowerCase().includes(busqueda)) ||
                    (c.direccion && c.direccion.toLowerCase().includes(busqueda))
                );
            }
            
            // Ordenar: Depto A-Z -> Negocio A-Z
            data.sort((a,b) => {
                if(a.departamento > b.departamento) return 1;
                if(a.departamento < b.departamento) return -1;
                if(a.negocio > b.negocio) return 1;
                if(a.negocio < b.negocio) return -1;
                return 0;
            });

            if(data.length === 0) { 
                document.getElementById('msgVacio').style.display='block'; 
                document.getElementById('msgVacio').textContent = busqueda ? 
                    'No se encontraron clientes que coincidan con la b√∫squeda.' : 
                    'No hay clientes registrados.';
                return; 
            }
            document.getElementById('msgVacio').style.display='none';

            data.forEach(c => {
                const enRuta = ruta.includes(c.id);
                const visitado = c.fecha === hoy;
                const mapLink = c.lat ? (c.lat==='MANUAL'?c.lng:`https://www.google.com/maps/search/?api=1&query=${c.lat},${c.lng}`) : null;

                const div = document.createElement('div');
                div.className = 'card';
                div.style.display = 'flex';
                div.innerHTML = `
                    <div style="padding-right:10px; display:flex; align-items:center;">
                        <input type="checkbox" class="check-ruta" onchange="toggleRuta(${c.id})" ${enRuta?'checked':''}>
                    </div>
                    <div style="flex-grow:1;">
                        <span class="tag-dept">${c.departamento}</span>
                        <div style="font-weight:bold; font-size:1.1em; color:#333; margin-top:2px;">${c.negocio}</div>
                        <div style="font-size:0.9em; color:#666;">${c.encargado}</div>
                        <div style="font-size:0.8em; color:#666;">üìû ${c.telefono || 'Sin tel√©fono'}</div>
                        ${c.contactoWhatsApp ? '<span style="font-size:0.7em; color:#25D366; margin-right:5px;">üíö WhatsApp</span>' : ''}
                        ${c.contactoLlamada ? '<span style="font-size:0.7em; color:#4285F4; margin-right:5px;">üìû Llamada</span>' : ''}
                        ${c.contactoOtro ? '<span style="font-size:0.7em; color:#757575;">üîò Otro</span>' : ''}
                        ${visitado ? `<span class="tag-visited">‚úÖ GESTIONADO HOY</span>` : `<span style="font-size:0.8em; color:#999;">üìÖ √öltima gesti√≥n: ${c.fecha||'N/A'}</span>`}
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px; justify-content:center; margin-left:5px;">
                        ${mapLink ? `<button class="btn-icon" style="background:#00bcd4;" onclick="window.open('${mapLink}','_blank')">üó∫Ô∏è</button>` : ''}
                        <button class="btn-icon btn-warning" onclick="editar(${c.id})">‚úèÔ∏è</button>
                        <button class="btn-icon btn-danger" onclick="borrar(${c.id})">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(div);
            });
            actualizarBadge();
        }

        // --- RUTA CON OPTIMIZACI√ìN ---
        function toggleRuta(id) {
            const i = ruta.indexOf(id);
            if(i < 0) ruta.push(id); 
            else ruta.splice(i,1);
            rutaOptimizada = false; // Resetear optimizaci√≥n si se modifica la ruta
            localStorage.setItem('db_ruta_v9', JSON.stringify(ruta));
            renderDashboard();
            actualizarBadge();
            if (!document.getElementById('view-ruta').classList.contains('hidden')) {
                renderRuta();
            }
        }
        
        function actualizarBadge() {
            const b = document.getElementById('badge');
            if(ruta.length>0) { 
                b.textContent=ruta.length; 
                b.classList.remove('hidden'); 
            } else {
                b.classList.add('hidden');
            }
        }
        
        function limpiarRuta() {
            if(confirm("¬øLimpiar toda la ruta pendiente?")) { 
                ruta = []; 
                rutaOptimizada = false;
                localStorage.setItem('db_ruta_v9', JSON.stringify(ruta)); 
                renderDashboard(); 
                renderRuta(); 
                actualizarBadge(); 
            }
        }
        
        // Funci√≥n Haversine para calcular distancia entre dos puntos GPS
        function calcularDistanciaHaversine(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radio de la Tierra en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distancia en km
        }
        
        // Optimizar ruta por proximidad
        function optimizarRuta() {
            const items = db.filter(c => ruta.includes(c.id));
            
            if(items.length < 2) {
                return alert("Se necesitan al menos 2 clientes en la ruta para optimizar.");
            }
            
            // Verificar que todos los clientes tengan GPS
            const clientesSinGPS = items.filter(c => !c.lat || c.lat === "MANUAL");
            if(clientesSinGPS.length > 0) {
                alert(`‚ö†Ô∏è ${clientesSinGPS.length} cliente(s) no tienen GPS y no se incluir√°n en la optimizaci√≥n.`);
            }
            
            const clientesConGPS = items.filter(c => c.lat && c.lat !== "MANUAL");
            
            if(clientesConGPS.length < 2) {
                return alert("Se necesitan al menos 2 clientes con GPS para optimizar la ruta.");
            }
            
            // Obtener ubicaci√≥n actual
            document.getElementById('gpsTxt').textContent = "Buscando ubicaci√≥n para optimizar...";
            
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        ubicacionActual = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        
                        // Algoritmo simple: ordenar por distancia a la ubicaci√≥n actual
                        clientesConGPS.sort((a, b) => {
                            const distA = calcularDistanciaHaversine(
                                ubicacionActual.lat, ubicacionActual.lon,
                                parseFloat(a.lat), parseFloat(a.lng)
                            );
                            const distB = calcularDistanciaHaversine(
                                ubicacionActual.lat, ubicacionActual.lon,
                                parseFloat(b.lat), parseFloat(b.lng)
                            );
                            return distA - distB;
                        });
                        
                        // Reconstruir la ruta con el orden optimizado
                        const nuevosIds = clientesConGPS.map(c => c.id);
                        // Agregar los clientes sin GPS al final
                        const idsSinGPS = clientesSinGPS.map(c => c.id);
                        ruta = [...nuevosIds, ...idsSinGPS];
                        
                        rutaOptimizada = true;
                        localStorage.setItem('db_ruta_v9', JSON.stringify(ruta));
                        
                        renderRuta();
                        alert(`‚úÖ Ruta optimizada por proximidad. Ordenados ${clientesConGPS.length} clientes por distancia.`);
                    },
                    error => {
                        alert("No se pudo obtener la ubicaci√≥n actual. Usando orden por departamento.");
                        // Ordenar por departamento si no hay GPS
                        ordenarRutaPorDepartamento();
                    },
                    {enableHighAccuracy: true, timeout: 10000}
                );
            } else {
                alert("El navegador no soporta geolocalizaci√≥n. Usando orden por departamento.");
                ordenarRutaPorDepartamento();
            }
        }
        
        function ordenarRutaPorDepartamento() {
            const items = db.filter(c => ruta.includes(c.id));
            
            // Ordenar por departamento y luego por negocio
            items.sort((a,b) => {
                if(a.departamento > b.departamento) return 1;
                if(a.departamento < b.departamento) return -1;
                if(a.negocio > b.negocio) return 1;
                if(a.negocio < b.negocio) return -1;
                return 0;
            });
            
            // Reconstruir ruta con nuevo orden
            ruta = items.map(c => c.id);
            rutaOptimizada = false;
            localStorage.setItem('db_ruta_v9', JSON.stringify(ruta));
            renderRuta();
        }
        
        function renderRuta() {
            const con = document.getElementById('listaRutaContainer'); 
            const rutaInfo = document.getElementById('rutaInfo');
            const distanciaTotalElem = document.getElementById('distanciaTotal');
            con.innerHTML='';
            
            const items = db.filter(c => ruta.includes(c.id));
            
            if(items.length===0) { 
                con.innerHTML='<p style="text-align:center; padding:20px; color:#777;">No hay clientes en la ruta.</p>'; 
                rutaInfo.textContent = '0 clientes en ruta';
                distanciaTotalElem.textContent = '';
                return; 
            }
            
            rutaInfo.textContent = `${items.length} cliente(s) en ruta`;
            
            // Calcular distancia total si la ruta est√° optimizada y hay GPS
            let distanciaTotal = 0;
            if(rutaOptimizada && items.length > 1) {
                for(let i = 0; i < items.length - 1; i++) {
                    const clienteActual = items[i];
                    const clienteSiguiente = items[i + 1];
                    
                    if(clienteActual.lat && clienteActual.lat !== "MANUAL" &&
                       clienteSiguiente.lat && clienteSiguiente.lat !== "MANUAL") {
                        distanciaTotal += calcularDistanciaHaversine(
                            parseFloat(clienteActual.lat), parseFloat(clienteActual.lng),
                            parseFloat(clienteSiguiente.lat), parseFloat(clienteSiguiente.lng)
                        );
                    }
                }
                
                if(distanciaTotal > 0) {
                    distanciaTotalElem.textContent = `üìè Distancia total: ${distanciaTotal.toFixed(1)} km`;
                } else {
                    distanciaTotalElem.textContent = '';
                }
            } else {
                distanciaTotalElem.textContent = '';
            }
            
            // Mostrar clientes en el orden actual
            items.forEach((c, index) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.borderLeft = '5px solid #1976d2';
                div.style.marginTop = '5px';
                
                if(rutaOptimizada) {
                    div.classList.add('route-optimized');
                }
                
                let infoDistancia = '';
                if(rutaOptimizada && index > 0 && items[index-1].lat && items[index-1].lat !== "MANUAL" &&
                   c.lat && c.lat !== "MANUAL") {
                    const distancia = calcularDistanciaHaversine(
                        parseFloat(items[index-1].lat), parseFloat(items[index-1].lng),
                        parseFloat(c.lat), parseFloat(c.lng)
                    );
                    infoDistancia = `<span class="route-distance">(${distancia.toFixed(1)} km desde anterior)</span>`;
                }
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div style="font-weight: bold; font-size: 1.1em;">${index + 1}. ${c.negocio}</div>
                            <div style="font-size: 0.9em; color: #666;">${c.direccion || 'Sin direcci√≥n'}</div>
                            <div style="margin-top: 5px;">
                                <span class="tag-dept">${c.departamento}</span>
                                ${infoDistancia}
                            </div>
                            <div style="margin-top: 5px; font-size: 0.8em;">
                                ${c.contactoWhatsApp ? '<span style="color:#25D366; margin-right:10px;">üíö WhatsApp</span>' : ''}
                                ${c.contactoLlamada ? '<span style="color:#4285F4; margin-right:10px;">üìû Llamada</span>' : ''}
                                ${c.contactoOtro ? '<span style="color:#757575;">üîò Otro</span>' : ''}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button class="btn-icon btn-danger" onclick="toggleRuta(${c.id}); renderRuta();" style="font-size:12px;">‚úï</button>
                            ${c.lat && c.lat !== "MANUAL" ? 
                                `<button class="btn-icon" style="background:#00bcd4; font-size:12px;" onclick="window.open('https://www.google.com/maps/search/?api=1&query=${c.lat},${c.lng}','_blank')">üó∫Ô∏è</button>` : 
                                ''
                            }
                        </div>
                    </div>
                    <div style="margin-top:10px; display:flex; justify-content:space-between;">
                        <button class="btn-secondary" style="padding:8px 12px; border:none; border-radius:4px; color:white; font-size:14px;" onclick="toggleRuta(${c.id}); renderRuta();">Descartar</button>
                        <button class="btn-success" style="padding:8px 12px; border:none; border-radius:4px; color:white; font-size:14px; font-weight:bold;" onclick="gestionar(${c.id})">‚úÖ Gestionar Visita</button>
                    </div>
                `;
                con.appendChild(div);
            });
        }
        
        function abrirMapaRuta() {
            const items = db.filter(c => ruta.includes(c.id) && c.lat && c.lat !== "MANUAL");
            if(items.length===0) return alert("Agrega clientes con GPS a la ruta primero.");
            
            let url = "https://www.google.com/maps/dir/";
            
            // Si hay ubicaci√≥n actual, empezar desde ah√≠
            if(ubicacionActual) {
                url += `${ubicacionActual.lat},${ubicacionActual.lon}/`;
            }
            
            // Agregar todos los clientes de la ruta
            items.forEach((c, i) => {
                if(i > 0 || ubicacionActual) url += '/';
                url += `${c.lat},${c.lng}`;
            });
            
            window.open(url, '_blank');
        }

        // --- CRUD (AGREGAR/EDITAR) ---
        function nuevoCliente() { 
            limpiarForm(); 
            document.getElementById('tituloForm').textContent="Nuevo Cliente"; 
            document.getElementById('btnFin').textContent="üíæ GUARDAR"; 
            mostrar('view-form'); 
        }
        
        function editar(id) { 
            cargarForm(id); 
            document.getElementById('tituloForm').textContent="Editar Cliente"; 
            document.getElementById('btnFin').textContent="üíæ ACTUALIZAR"; 
            mostrar('view-form'); 
        }
        
        function gestionar(id) { 
            cargarForm(id); 
            document.getElementById('flagRuta').value="1"; 
            document.getElementById('tituloForm').textContent="Gestionando Visita"; 
            document.getElementById('btnFin').textContent="‚úÖ FINALIZAR GESTI√ìN"; 
            mostrar('view-form'); 
        }

        function cargarForm(id) {
            const c = db.find(x => x.id === id);
            if(!c) return;
            
            document.getElementById('idCliente').value = c.id;
            document.getElementById('negocio').value = c.negocio || '';
            document.getElementById('departamento').value = c.departamento || 'Guatemala';
            document.getElementById('direccion').value = c.direccion || '';
            document.getElementById('encargado').value = c.encargado || '';
            document.getElementById('telefono').value = c.telefono || '';
            document.getElementById('cita').value = c.cita || '';
            document.getElementById('lat').value = c.lat || '';
            document.getElementById('lng').value = c.lng || '';
            document.getElementById('mensajeWhatsApp').value = c.mensajeWhatsApp || '';
            
            // Cargar opciones de contacto
            document.getElementById('contactoWhatsApp').checked = c.contactoWhatsApp || false;
            document.getElementById('contactoLlamada').checked = c.contactoLlamada || false;
            document.getElementById('contactoOtro').checked = c.contactoOtro || false;
            
            // Cargar opciones de contacto para cita
            document.getElementById('citaWhatsApp').checked = c.citaWhatsApp || false;
            document.getElementById('citaLlamada').checked = c.citaLlamada || false;
            document.getElementById('citaOtro').checked = c.citaOtro || false;
            
            document.getElementById('gpsTxt').textContent = c.lat ? "‚úÖ GPS Guardado" : "Sin GPS";
        }
        
        function limpiarForm() {
            document.getElementById('idCliente').value = '';
            document.getElementById('negocio').value = '';
            document.getElementById('departamento').value = 'Guatemala';
            document.getElementById('direccion').value = '';
            document.getElementById('encargado').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('cita').value = '';
            document.getElementById('lat').value = '';
            document.getElementById('lng').value = '';
            document.getElementById('mensajeWhatsApp').value = '';
            document.getElementById('flagRuta').value = '0';
            document.getElementById('gpsTxt').textContent = "Esperando...";
            document.getElementById('boxManual').classList.add('hidden');
            document.getElementById('linkMan').value = '';
            document.getElementById('foto').value = '';
            
            // Limpiar checkboxes de contacto
            document.getElementById('contactoWhatsApp').checked = false;
            document.getElementById('contactoLlamada').checked = false;
            document.getElementById('contactoOtro').checked = false;
            
            // Limpiar checkboxes de contacto para cita
            document.getElementById('citaWhatsApp').checked = false;
            document.getElementById('citaLlamada').checked = false;
            document.getElementById('citaOtro').checked = false;
        }
        
        function borrar(id) {
            if(confirm("¬øEliminar este cliente permanentemente?")) {
                db = db.filter(x => x.id !== id); 
                ruta = ruta.filter(x => x !== id);
                guardarDB(); 
                renderDashboard();
                // Si estamos en reportes, regenerar el reporte
                if (!document.getElementById('view-reportes').classList.contains('hidden')) {
                    regenerarReporteActual();
                }
            }
        }
        
        function irGPS() {
            const telefono = document.getElementById('telefono').value.trim();
            if(!document.getElementById('negocio').value.trim()) {
                return alert("El nombre del negocio es obligatorio.");
            }
            if(!telefono) {
                return alert("El n√∫mero de tel√©fono es obligatorio.");
            }
            if(telefono.length !== 8) {
                return alert("El n√∫mero de tel√©fono debe tener 8 d√≠gitos.");
            }
            if(!/^\d+$/.test(telefono)) {
                return alert("El n√∫mero de tel√©fono solo debe contener d√≠gitos.");
            }
            mostrar('view-gps');
        }
        
        function obtenerGPS() {
            const s = document.getElementById('gpsTxt'); 
            s.textContent = "Buscando GPS...";
            
            if(!navigator.geolocation) { 
                s.textContent = "Error: GPS no soportado"; 
                document.getElementById('boxManual').classList.remove('hidden'); 
                return; 
            }
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    document.getElementById('lat').value = position.coords.latitude;
                    document.getElementById('lng').value = position.coords.longitude;
                    s.textContent = "‚úÖ Ubicaci√≥n obtenida correctamente";
                }, 
                error => { 
                    s.textContent = "‚ùå Error al obtener GPS"; 
                    document.getElementById('boxManual').classList.remove('hidden'); 
                }, 
                {enableHighAccuracy: true, timeout: 10000}
            );
        }
        
        function usarManual() {
            const link = document.getElementById('linkMan').value;
            if(link) { 
                document.getElementById('lat').value = "MANUAL"; 
                document.getElementById('lng').value = link; 
                document.getElementById('gpsTxt').textContent = "‚úÖ Link guardado"; 
            }
        }
        
        // --- FOTO ---
        document.getElementById('foto').addEventListener('change', function(e){
            if(e.target.files[0]) {
                const depto = document.getElementById('departamento').value.toUpperCase().replace(/\s/g,'_');
                const negocio = document.getElementById('negocio').value.replace(/[^a-z0-9]/gi, '_').substring(0, 20);
                const fecha = new Date().toISOString().slice(0,10).replace(/-/g, '');
                const hora = new Date().toTimeString().slice(0,8).replace(/:/g, '');
                
                const a = document.createElement('a');
                a.href = URL.createObjectURL(e.target.files[0]);
                a.download = `${depto}_${negocio}_${fecha}_${hora}.jpg`;
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a);
            }
        });

        // --- GUARDAR ---
        function guardar() {
            const id = document.getElementById('idCliente').value;
            const nuevoId = id ? parseInt(id) : Date.now();
            const telefono = document.getElementById('telefono').value.trim();
            
            // Validaciones
            if(!document.getElementById('negocio').value.trim()) {
                return alert("El nombre del negocio es obligatorio.");
            }
            if(!document.getElementById('departamento').value) {
                return alert("Debe seleccionar un departamento.");
            }
            if(!telefono) {
                return alert("El n√∫mero de tel√©fono es obligatorio.");
            }
            if(telefono.length !== 8) {
                return alert("El n√∫mero de tel√©fono debe tener 8 d√≠gitos.");
            }
            if(!/^\d+$/.test(telefono)) {
                return alert("El n√∫mero de tel√©fono solo debe contener d√≠gitos.");
            }
            
            const data = {
                id: nuevoId,
                negocio: document.getElementById('negocio').value.trim(),
                departamento: document.getElementById('departamento').value,
                direccion: document.getElementById('direccion').value.trim(),
                encargado: document.getElementById('encargado').value.trim(),
                telefono: telefono,
                cita: document.getElementById('cita').value,
                lat: document.getElementById('lat').value,
                lng: document.getElementById('lng').value,
                mensajeWhatsApp: document.getElementById('mensajeWhatsApp').value.trim(),
                contactoWhatsApp: document.getElementById('contactoWhatsApp').checked,
                contactoLlamada: document.getElementById('contactoLlamada').checked,
                contactoOtro: document.getElementById('contactoOtro').checked,
                citaWhatsApp: document.getElementById('citaWhatsApp').checked,
                citaLlamada: document.getElementById('citaLlamada').checked,
                citaOtro: document.getElementById('citaOtro').checked,
                fecha: new Date().toISOString().split('T')[0]
            };

            const idx = db.findIndex(x => x.id === nuevoId);
            if(idx >= 0) {
                db[idx] = data;
            } else {
                db.push(data);
            }

            if(document.getElementById('flagRuta').value === "1") {
                const ri = ruta.indexOf(nuevoId);
                if(ri >= 0) ruta.splice(ri, 1);
            }

            guardarDB();
            alert("‚úÖ Guardado exitosamente");
            limpiarForm();
            mostrar('view-dashboard');
            renderDashboard();
        }
        
        function guardarDB() { 
            localStorage.setItem('db_clientes_v9', JSON.stringify(db)); 
            localStorage.setItem('db_ruta_v9', JSON.stringify(ruta)); 
        }

        // --- REPORTES CON EXPORTACI√ìN CSV ---
        function reporteDiario() {
            const hoy = new Date().toISOString().split('T')[0];
            filtrosReporteActual = { tipo: 'diario', fecha: hoy, depto: null };
            generarTablaReporte(hoy, null, "REPORTE DE VISITAS DEL D√çA", `Fecha: ${hoy}`);
        }
        
        function reporteTotal() {
            filtrosReporteActual = { tipo: 'total', fecha: null, depto: null };
            generarTablaReporte(null, null, "CARTERA TOTAL DE CLIENTES", "Listado completo ordenado por departamento");
        }
        
        function reporteCustom() {
            const f = document.getElementById('repFecha').value;
            const d = document.getElementById('filtroDeptReporte').value;
            filtrosReporteActual = { tipo: 'custom', fecha: f, depto: d };
            generarTablaReporte(f, d, "REPORTE PERSONALIZADO", `Filtros: ${f || 'Cualquier fecha'} - ${d || 'Todos los departamentos'}`);
        }

        function generarTablaReporte(fechaFiltro, deptFiltro, titulo, subtitulo) {
            const tbody = document.querySelector('#tablaRep tbody');
            tbody.innerHTML = '';
            document.getElementById('tituloReporte').textContent = titulo;
            document.getElementById('subtituloReporte').textContent = subtitulo;

            let datos = [...db];
            
            // Aplicar filtros
            if(fechaFiltro) datos = datos.filter(c => c.fecha === fechaFiltro);
            if(deptFiltro) datos = datos.filter(c => c.departamento === deptFiltro);
            
            // Ordenar por departamento y luego por negocio
            datos.sort((a,b) => {
                if(a.departamento > b.departamento) return 1;
                if(a.departamento < b.departamento) return -1;
                if(a.negocio > b.negocio) return 1;
                if(a.negocio < b.negocio) return -1;
                return 0;
            });

            if(datos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No se encontraron registros.</td></tr>';
                document.getElementById('resumenReporte').textContent = "Total: 0 registros";
                return;
            }

            // Agrupar por departamento para mejor visualizaci√≥n
            const agrupados = {};
            datos.forEach(c => {
                if(!agrupados[c.departamento]) {
                    agrupados[c.departamento] = [];
                }
                agrupados[c.departamento].push(c);
            });

            // Construir tabla agrupada
            Object.keys(agrupados).sort().forEach(depto => {
                // Agregar fila de encabezado del departamento
                tbody.innerHTML += `
                    <tr style="background:#e3f2fd;">
                        <td colspan="5" style="font-weight:bold; color:#1565c0; text-transform:uppercase;">
                            üìç ${depto} (${agrupados[depto].length} clientes)
                        </td>
                    </tr>
                `;
                
                // Agregar cada cliente del departamento
                agrupados[depto].forEach(c => {
                    // Formatear opciones de contacto
                    const opcionesContacto = [];
                    if(c.contactoWhatsApp) opcionesContacto.push('WhatsApp');
                    if(c.contactoLlamada) opcionesContacto.push('Llamada');
                    if(c.contactoOtro) opcionesContacto.push('Otro');
                    
                    const opcionesCita = [];
                    if(c.citaWhatsApp) opcionesCita.push('WhatsApp');
                    if(c.citaLlamada) opcionesCita.push('Llamada');
                    if(c.citaOtro) opcionesCita.push('Otro');
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <b>${c.negocio}</b><br>
                                <small>üë§ ${c.encargado || 'Sin encargado'}</small><br>
                                <small>ID: ${c.id}</small>
                            </td>
                            <td>
                                ${c.direccion || 'Sin direcci√≥n'}<br>
                                <small>üìû ${c.telefono || 'Sin tel√©fono'}</small>
                            </td>
                            <td>
                                <small><b>Contacto:</b> ${opcionesContacto.length > 0 ? opcionesContacto.join(' ‚Ä¢ ') : 'No especificado'}</small><br>
                                <small><b>Recordatorio:</b> ${opcionesCita.length > 0 ? opcionesCita.join(' ‚Ä¢ ') : 'No especificado'}</small>
                                ${c.mensajeWhatsApp ? `<br><small><b>Mensaje:</b> ${c.mensajeWhatsApp}</small>` : ''}
                            </td>
                            <td>
                                üìÖ ${c.fecha || 'Sin fecha'}<br>
                                <small>${c.cita ? '‚è∞ Cita: ' + c.cita.replace('T', ' ') : 'Sin cita'}</small>
                            </td>
                            <td class="no-print">
                                <button class="btn-icon btn-danger" onclick="eliminarDesdeReporte(${c.id})">üóëÔ∏è</button>
                                <button class="btn-icon btn-warning" onclick="editar(${c.id}); mostrar('view-form')">‚úèÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            });
            
            document.getElementById('resumenReporte').textContent = 
                `Total: ${datos.length} cliente(s) | Departamentos: ${Object.keys(agrupados).length}`;
        }
        
        function eliminarDesdeReporte(id) {
            if(confirm("¬øEliminar este cliente permanentemente?")) {
                db = db.filter(x => x.id !== id);
                ruta = ruta.filter(x => x !== id);
                guardarDB();
                renderDashboard();
                regenerarReporteActual();
            }
        }
        
        function eliminarTodosDelReporte() {
            if(db.length === 0) {
                return alert("No hay clientes para eliminar.");
            }
            
            const confirmacion = prompt(`¬øEst√° seguro de eliminar TODOS los clientes? Esta acci√≥n no se puede deshacer.\n\nEscriba "ELIMINAR" para confirmar:`);
            
            if(confirmacion === "ELIMINAR") {
                // Determinar qu√© clientes est√°n en el reporte actual
                let clientesAEliminar = [...db];
                
                // Aplicar filtros actuales
                if(filtrosReporteActual.fecha) {
                    clientesAEliminar = clientesAEliminar.filter(c => c.fecha === filtrosReporteActual.fecha);
                }
                if(filtrosReporteActual.depto) {
                    clientesAEliminar = clientesAEliminar.filter(c => c.departamento === filtrosReporteActual.depto);
                }
                
                if(clientesAEliminar.length === 0) {
                    return alert("No hay clientes que coincidan con los filtros actuales.");
                }
                
                if(confirm(`‚ö†Ô∏è ADVERTENCIA FINAL\n\nSe eliminar√°n ${clientesAEliminar.length} cliente(s) permanentemente.\n\n¬øContinuar?`)) {
                    // Eliminar los clientes del reporte actual
                    const idsAEliminar = clientesAEliminar.map(c => c.id);
                    db = db.filter(c => !idsAEliminar.includes(c.id));
                    ruta = ruta.filter(id => !idsAEliminar.includes(id));
                    
                    guardarDB();
                    alert(`‚úÖ Se eliminaron ${clientesAEliminar.length} cliente(s) exitosamente.`);
                    renderDashboard();
                    regenerarReporteActual();
                }
            } else {
                alert("Eliminaci√≥n cancelada.");
            }
        }
        
        function regenerarReporteActual() {
            switch(filtrosReporteActual.tipo) {
                case 'diario':
                    reporteDiario();
                    break;
                case 'total':
                    reporteTotal();
                    break;
                case 'custom':
                    reporteCustom();
                    break;
                default:
                    reporteTotal();
            }
        }
        
        // --- EXPORTACI√ìN A CSV ---
        function exportarCSV() {
            // Obtener los datos filtrados seg√∫n el reporte actual
            let datos = [...db];
            
            // Aplicar los mismos filtros que el reporte actual
            if(filtrosReporteActual.fecha) {
                datos = datos.filter(c => c.fecha === filtrosReporteActual.fecha);
            }
            if(filtrosReporteActual.depto) {
                datos = datos.filter(c => c.departamento === filtrosReporteActual.depto);
            }
            
            if(datos.length === 0) {
                return alert("No hay datos para exportar.");
            }
            
            // Ordenar los datos igual que en el reporte
            datos.sort((a,b) => {
                if(a.departamento > b.departamento) return 1;
                if(a.departamento < b.departamento) return -1;
                if(a.negocio > b.negocio) return 1;
                if(a.negocio < b.negocio) return -1;
                return 0;
            });
            
            // Crear encabezados CSV
            const headers = [
                'ID',
                'Negocio',
                'Departamento',
                'Direcci√≥n',
                'Encargado',
                'Tel√©fono',
                'Contacto WhatsApp',
                'Contacto Llamada',
                'Contacto Otro',
                'Mensaje WhatsApp',
                '√öltima Visita',
                'Pr√≥xima Cita',
                'Recordatorio WhatsApp',
                'Recordatorio Llamada',
                'Recordatorio Otro',
                'Latitud',
                'Longitud'
            ];
            
            // Crear filas de datos
            const rows = datos.map(c => {
                return [
                    c.id,
                    `"${c.negocio.replace(/"/g, '""')}"`,
                    `"${c.departamento}"`,
                    `"${(c.direccion || '').replace(/"/g, '""')}"`,
                    `"${(c.encargado || '').replace(/"/g, '""')}"`,
                    c.telefono || '',
                    c.contactoWhatsApp ? 'SI' : 'NO',
                    c.contactoLlamada ? 'SI' : 'NO',
                    c.contactoOtro ? 'SI' : 'NO',
                    `"${(c.mensajeWhatsApp || '').replace(/"/g, '""')}"`,
                    c.fecha || '',
                    c.cita ? c.cita.replace('T', ' ') : '',
                    c.citaWhatsApp ? 'SI' : 'NO',
                    c.citaLlamada ? 'SI' : 'NO',
                    c.citaOtro ? 'SI' : 'NO',
                    c.lat || '',
                    c.lng || ''
                ].join(',');
            });
            
            // Combinar encabezados y filas
            const csvContent = [headers.join(','), ...rows].join('\n');
            
            // Crear y descargar archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Generar nombre de archivo basado en el tipo de reporte
            let filename = 'reporte_clientes';
            if(filtrosReporteActual.tipo === 'diario') {
                filename = `visitas_${new Date().toISOString().split('T')[0]}`;
            } else if(filtrosReporteActual.tipo === 'custom' && filtrosReporteActual.depto) {
                filename = `clientes_${filtrosReporteActual.depto.replace(/\s+/g, '_')}`;
            }
            
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Se exportaron ${datos.length} registros a CSV.`);
        }
        
        function agendarCal() {
            const n = document.getElementById('negocio').value;
            const c = document.getElementById('cita').value;
            if(!c) return alert("Seleccione fecha y hora para la cita.");
            
            const fecha = new Date(c);
            const inicio = fecha.toISOString().replace(/-|:|\.\d\d\d/g,"");
            const fin = new Date(fecha.getTime() + 60*60*1000).toISOString().replace(/-|:|\.\d\d\d/g,"");
            
            window.open(
                `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(n)}&dates=${inicio}/${fin}`,
                '_blank'
            );
        }
    </script>
</body>
</html>