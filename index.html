<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ruta de Clientes GT</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; padding-bottom: 70px; }
        header { background-color: #007bff; color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .container { max-width: 600px; margin: 0 auto; padding: 10px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        h3 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1.1em; }
        label { font-weight: 600; font-size: 0.85em; color: #666; display: block; margin-top: 12px; }
        
        /* Inputs m√°s grandes para dedos */
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; }
        input:focus, select:focus { border-color: #007bff; outline: none; }
        
        /* Botones t√°ctiles */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 15px; color: white; font-weight: 600; transition: background 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: #007bff; }
        .btn-success { background-color: #28a745; }
        .btn-secondary { background-color: #6c757d; }
        .btn-info { background-color: #17a2b8; }
        
        /* Men√∫ inferior fijo */
        .nav-bar { display: flex; justify-content: space-around; background: white; padding: 10px 0; position: fixed; bottom: 0; width: 100%; border-top: 1px solid #ddd; z-index: 1000; }
        .nav-btn { background: none; border: none; color: #555; font-size: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; width: 33%; }
        .nav-btn.active { color: #007bff; font-weight: bold; }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }
        
        /* Utilidades */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .status-msg { font-size: 0.9em; margin-top: 8px; font-weight: 500; }
        
        /* Tabla responsive */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; }
        th, td { border-bottom: 1px solid #eee; padding: 10px 5px; text-align: left; }
        th { color: #555; font-size: 0.8em; text-transform: uppercase; }

        /* Estilo para impresi√≥n */
        @media print {
            .no-print, .nav-bar, header { display: none !important; }
            body { padding: 0; background: white; }
            .card { box-shadow: none; border: none; padding: 0; }
            .container { max-width: 100%; }
        }
    </style>
</head>
<body>

    <header class="no-print">Ruta Comercial GT</header>

    <div class="container">

        <div id="view-dashboard" class="view-section">
            <div class="card">
                <h3>Listado de Clientes</h3>
                
                <label>Filtrar por Departamento:</label>
                <select id="filtroDeptDash" onchange="renderizarTablaDashboard()">
                    <option value="">Mostrar Todos</option>
                </select>
                
                <div style="margin-top:15px; overflow-x:auto;">
                    <table id="tablaDashboard">
                        <thead><tr><th>Cliente</th><th>Depto.</th><th>Acci√≥n</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <p id="emptyMsg" class="text-center" style="color:#999; display:none;">No hay registros a√∫n.</p>
            </div>
            <button class="btn btn-primary" onclick="irAEtapa1()">+ Nuevo Ingreso</button>
        </div>

        <div id="view-etapa1" class="view-section hidden">
            <div class="card">
                <h3>1. Datos del Cliente</h3>
                
                <label>Nombre del Negocio *</label>
                <input type="text" id="negocio" placeholder="Ej: Tienda La Bendici√≥n">

                <label>Departamento *</label>
                <select id="departamento">
                    </select>

                <label>Direcci√≥n Manual</label>
                <input type="text" id="direccion" placeholder="Zona, Calle, Referencia...">

                <label>Encargado</label>
                <input type="text" id="encargado" placeholder="Nombre completo">

                <label>Tel√©fono</label>
                <input type="tel" id="telefono" placeholder="########">

                <label>Cita (Opcional)</label>
                <input type="datetime-local" id="cita">
                <button class="btn btn-secondary" style="padding:10px; font-size:14px;" onclick="agendarCalendario()">üìÖ Agendar en Google</button>

                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn btn-secondary" onclick="mostrarVista('view-dashboard')">Cancelar</button>
                    <button class="btn btn-primary" onclick="validarEtapa1()">Siguiente ‚û°Ô∏è</button>
                </div>
            </div>
        </div>

        <div id="view-etapa2" class="view-section hidden">
            <div class="card">
                <h3>2. Validaci√≥n de Campo</h3>
                
                <label>Ubicaci√≥n GPS</label>
                <button type="button" class="btn btn-info" onclick="obtenerUbicacion()">üì° Obtener Coordenadas</button>
                <p id="gpsStatus" class="status-msg" style="color:#666;">No iniciada</p>
                <input type="hidden" id="lat"><input type="hidden" id="lng">

                <div id="manualLocation" class="hidden" style="background:#fff3cd; padding:10px; border-radius:8px; margin-top:10px;">
                    <small style="color:#856404;">‚ö†Ô∏è GPS fall√≥. Pega el link de Maps aqu√≠:</small>
                    <input type="text" id="linkManual" placeholder="https://maps.google.com/...">
                    <button class="btn btn-secondary" style="margin-top:5px; padding:8px;" onclick="usarUbicacionManual()">Usar Link</button>
                </div>

                <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">

                <label>Fotograf√≠a de Fachada</label>
                <div style="background: #e9ecef; padding: 10px; border-radius: 8px; font-size: 0.85em; margin-bottom: 10px;">
                    üì∑ La foto se guardar√° con el nombre del Departamento autom√°ticamente.
                </div>
                <input type="file" id="foto" accept="image/*" capture="environment">
                
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-secondary" onclick="mostrarVista('view-etapa1')">‚¨ÖÔ∏è Volver</button>
                    <button class="btn btn-success" onclick="guardarClienteFinal()">üíæ Finalizar</button>
                </div>
            </div>
        </div>

        <div id="view-reportes" class="view-section hidden">
            <div class="card no-print">
                <h3>Generador de Reportes</h3>
                <label>Fecha de Visita:</label>
                <input type="date" id="filtroFechaReporte">
                
                <label>Departamento:</label>
                <select id="filtroDeptReporte">
                    <option value="">Todos</option>
                </select>

                <button class="btn btn-primary" onclick="generarReporte()">üîç Generar Tabla</button>
            </div>

            <div class="card" id="areaImpresion">
                <h3 class="text-center">Reporte de Ruta</h3>
                <table id="tablaReporte">
                    <thead><tr><th>Negocio</th><th>Direcci√≥n</th><th>Contacto</th><th>Cita</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <button class="btn btn-secondary no-print" onclick="window.print()">üñ®Ô∏è Guardar PDF / Imprimir</button>
        </div>

    </div>

    <div class="nav-bar no-print">
        <button class="nav-btn active" id="btn-nav-home" onclick="mostrarVista('view-dashboard')">
            <span class="nav-icon">üè†</span>Inicio
        </button>
        <button class="nav-btn" id="btn-nav-add" onclick="irAEtapa1()">
            <span class="nav-icon">‚ûï</span>Nuevo
        </button>
        <button class="nav-btn" id="btn-nav-rep" onclick="irAReportes()">
            <span class="nav-icon">üìä</span>Reportes
        </button>
    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        const deptos = [
            "Alta Verapaz", "Baja Verapaz", "Chimaltenango", "Chiquimula", "El Progreso", 
            "Escuintla", "Guatemala", "Huehuetenango", "Izabal", "Jalapa", "Jutiapa", 
            "Pet√©n", "Quetzaltenango", "Quich√©", "Retalhuleu", "Sacatep√©quez", "San Marcos", 
            "Santa Rosa", "Solol√°", "Suchitep√©quez", "Totonicap√°n", "Zacapa"
        ];

        // INICIALIZACI√ìN
        document.addEventListener("DOMContentLoaded", () => {
            llenarSelects();
            renderizarTablaDashboard();
            document.getElementById('filtroFechaReporte').valueAsDate = new Date();
        });

        function llenarSelects() {
            ['departamento', 'filtroDeptDash', 'filtroDeptReporte'].forEach(id => {
                const s = document.getElementById(id);
                deptos.forEach(d => { 
                    let o = document.createElement('option'); 
                    o.value=d; o.textContent=d; 
                    s.appendChild(o); 
                });
            });
            // Seleccionar un default para que no est√© vac√≠o
            document.getElementById('departamento').value = "Guatemala";
        }

        // --- NAVEGACI√ìN ---
        function mostrarVista(id) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            
            // Actualizar estilo botones nav
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(id === 'view-dashboard') document.getElementById('btn-nav-home').classList.add('active');
            if(id.includes('etapa')) document.getElementById('btn-nav-add').classList.add('active');
            if(id === 'view-reportes') document.getElementById('btn-nav-rep').classList.add('active');
        }

        function irAEtapa1() {
            limpiarFormulario();
            mostrarVista('view-etapa1');
        }

        function irAReportes() { mostrarVista('view-reportes'); }

        // --- L√ìGICA DE FORMULARIO ---
        function validarEtapa1() {
            if(!document.getElementById('negocio').value) { alert("Por favor escribe el nombre del Negocio"); return; }
            mostrarVista('view-etapa2');
        }

        function agendarCalendario() {
            const val = document.getElementById('cita').value;
            if(!val) return alert("Selecciona fecha y hora primero");
            const d = new Date(val).toISOString().replace(/-|:|\.\d\d\d/g, "");
            const txt = encodeURIComponent(document.getElementById('negocio').value);
            window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=${txt}&dates=${d}/${d}`, '_blank');
        }

        // --- L√ìGICA DE FOTO (RENOMBRADO INTELIGENTE) ---
        document.getElementById('foto').addEventListener('change', function(e) {
            if(e.target.files[0]) {
                const depto = document.getElementById('departamento').value.toUpperCase().replace(/\s/g, '');
                const negocio = document.getElementById('negocio').value.replace(/\s/g, '_') || 'CLIENTE';
                const fecha = new Date().toISOString().slice(0,10);
                
                // NOMBRE DEL ARCHIVO: DEPARTAMENTO_Negocio_Fecha.jpg
                const nombreArchivo = `${depto}_${negocio}_${fecha}.jpg`;

                const a = document.createElement('a');
                a.href = URL.createObjectURL(e.target.files[0]);
                a.download = nombreArchivo; 
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
        });

        // --- L√ìGICA GPS (CON FALLBACK) ---
        function obtenerUbicacion() {
            const status = document.getElementById('gpsStatus');
            const manual = document.getElementById('manualLocation');
            status.textContent = "üì° Conectando sat√©lites...";
            status.style.color = "blue";
            manual.classList.add('hidden');

            if (!navigator.geolocation) {
                status.textContent = "‚ùå Navegador no compatible";
                manual.classList.remove('hidden');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById('lat').value = pos.coords.latitude;
                    document.getElementById('lng').value = pos.coords.longitude;
                    status.textContent = `‚úÖ Precisi√≥n: ${pos.coords.accuracy.toFixed(0)}m`;
                    status.style.color = "green";
                },
                (err) => {
                    console.log(err);
                    status.textContent = "‚ùå Error GPS. Usa el modo manual.";
                    status.style.color = "red";
                    manual.classList.remove('hidden');
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }

        function usarUbicacionManual() {
            const link = document.getElementById('linkManual').value;
            if(link.length > 5) {
                document.getElementById('lat').value = "MANUAL";
                document.getElementById('lng').value = link;
                document.getElementById('gpsStatus').textContent = "‚úÖ Link manual guardado";
                document.getElementById('gpsStatus').style.color = "green";
                document.getElementById('manualLocation').classList.add('hidden');
            } else { alert("Link inv√°lido"); }
        }

        // --- GUARDADO ---
        function guardarClienteFinal() {
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;

            if(!lat) {
                if(!confirm("No hay ubicaci√≥n GPS guardada. ¬øContinuar sin ubicaci√≥n?")) return;
            }

            const data = {
                id: Date.now(),
                negocio: document.getElementById('negocio').value,
                departamento: document.getElementById('departamento').value,
                direccion: document.getElementById('direccion').value,
                encargado: document.getElementById('encargado').value,
                telefono: document.getElementById('telefono').value,
                cita: document.getElementById('cita').value,
                lat: lat, lng: lng,
                fecha: new Date().toISOString().split('T')[0]
            };

            let db = JSON.parse(localStorage.getItem('db_ruta_final')) || [];
            db.push(data);
            localStorage.setItem('db_ruta_final', JSON.stringify(db));

            alert("‚úÖ Registro Exitoso");
            limpiarFormulario();
            mostrarVista('view-dashboard');
            renderizarTablaDashboard();
        }

        function limpiarFormulario() {
            document.querySelectorAll('input').forEach(i => i.value = '');
            document.getElementById('gpsStatus').textContent = 'No iniciada';
            document.getElementById('gpsStatus').style.color = '#666';
            document.getElementById('departamento').value = "Guatemala"; 
        }

        // --- RENDERS ---
        function renderizarTablaDashboard() {
            const db = JSON.parse(localStorage.getItem('db_ruta_final')) || [];
            const filtro = document.getElementById('filtroDeptDash').value;
            const tbody = document.querySelector('#tablaDashboard tbody');
            const msg = document.getElementById('emptyMsg');
            
            tbody.innerHTML = '';
            
            const filtrados = db.filter(c => !filtro || c.departamento === filtro);
            
            if(filtrados.length === 0) {
                msg.style.display = 'block';
            } else {
                msg.style.display = 'none';
                filtrados.forEach(c => {
                    let mapLink = c.lat === 'MANUAL' ? c.lng : `https://www.google.com/maps?q=${c.lat},${c.lng}`;
                    if(!c.lat) mapLink = null;

                    tbody.innerHTML += `
                        <tr>
                            <td><b>${c.negocio}</b><br><small>${c.encargado}</small></td>
                            <td>${c.departamento}</td>
                            <td>
                                ${mapLink ? `<a href="${mapLink}" target="_blank" style="text-decoration:none;">üó∫Ô∏è Ir</a>` : 'üö´'}
                            </td>
                        </tr>
                    `;
                });
            }
        }

        function generarReporte() {
            const db = JSON.parse(localStorage.getItem('db_ruta_final')) || [];
            const fDate = document.getElementById('filtroFechaReporte').value;
            const fDept = document.getElementById('filtroDeptReporte').value;
            const tbody = document.querySelector('#tablaReporte tbody');
            tbody.innerHTML = '';

            const filtrados = db.filter(c => 
                (!fDate || c.fecha === fDate) && 
                (!fDept || c.departamento === fDept)
            );

            if(filtrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No hay datos para este filtro</td></tr>';
                return;
            }

            filtrados.forEach(c => {
                tbody.innerHTML += `
                    <tr>
                        <td>${c.negocio}<br><small>(${c.departamento})</small></td>
                        <td>${c.direccion}</td>
                        <td>${c.encargado}<br>${c.telefono}</td>
                        <td>${c.cita ? c.cita.replace('T', ' ') : '-'}</td>
                    </tr>
                `;
            });
        }
    </script>
</body>
</html>
