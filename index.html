<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ruta de Clientes GT - Gesti√≥n</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; padding-bottom: 80px; }
        header { background-color: #007bff; color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .container { max-width: 600px; margin: 0 auto; padding: 10px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        h3 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1.1em; }
        label { font-weight: 600; font-size: 0.85em; color: #666; display: block; margin-top: 12px; }
        
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; }
        input:focus, select:focus { border-color: #007bff; outline: none; }
        
        /* Botones Generales */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 15px; color: white; font-weight: 600; transition: background 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: #007bff; }
        .btn-success { background-color: #28a745; }
        .btn-secondary { background-color: #6c757d; }
        .btn-info { background-color: #17a2b8; }
        
        /* Botones Peque√±os (Acciones) */
        .btn-sm { padding: 5px 10px; font-size: 14px; margin: 0 2px; width: auto; display: inline-block; }
        .btn-edit { background-color: #ffc107; color: #333; }
        .btn-del { background-color: #dc3545; color: white; }
        
        /* Men√∫ inferior */
        .nav-bar { display: flex; justify-content: space-around; background: white; padding: 10px 0; position: fixed; bottom: 0; width: 100%; border-top: 1px solid #ddd; z-index: 1000; }
        .nav-btn { background: none; border: none; color: #555; font-size: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; width: 33%; }
        .nav-btn.active { color: #007bff; font-weight: bold; }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }
        
        /* Utilidades */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .status-msg { font-size: 0.9em; margin-top: 8px; font-weight: 500; }
        
        /* Tabla */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; }
        th, td { border-bottom: 1px solid #eee; padding: 10px 5px; text-align: left; }
        th { color: #555; font-size: 0.8em; text-transform: uppercase; }

        @media print {
            .no-print, .nav-bar, header { display: none !important; }
            body { padding: 0; background: white; }
            .card { box-shadow: none; border: none; padding: 0; }
        }
    </style>
</head>
<body>

    <header class="no-print">Gesti√≥n de Ruta</header>

    <div class="container">

        <div id="view-dashboard" class="view-section">
            <div class="card">
                <h3>Clientes Registrados</h3>
                <label>Filtrar Depto:</label>
                <select id="filtroDeptDash" onchange="renderizarTablaDashboard()">
                    <option value="">Todos</option>
                </select>
                
                <div style="margin-top:15px; overflow-x:auto;">
                    <table id="tablaDashboard">
                        <thead><tr><th>Cliente</th><th>Depto.</th><th style="text-align:center">Acciones</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <p id="emptyMsg" class="text-center" style="color:#999; display:none;">No hay datos.</p>
            </div>
            <button class="btn btn-primary" onclick="irAEtapa1(true)">+ Nuevo Cliente</button>
        </div>

        <div id="view-etapa1" class="view-section hidden">
            <div class="card">
                <h3 id="tituloForm">Datos del Cliente</h3>
                
                <input type="hidden" id="editandoId" value=""> <label>Nombre del Negocio *</label>
                <input type="text" id="negocio" placeholder="Ej: Tienda La Bendici√≥n">

                <label>Departamento *</label>
                <select id="departamento"></select>

                <label>Direcci√≥n</label>
                <input type="text" id="direccion" placeholder="Zona, Calle...">

                <label>Encargado</label>
                <input type="text" id="encargado">

                <label>Tel√©fono</label>
                <input type="tel" id="telefono">

                <label>Cita</label>
                <input type="datetime-local" id="cita">
                <button class="btn btn-secondary" onclick="agendarCalendario()">üìÖ Agendar en Google</button>

                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn btn-secondary" onclick="mostrarVista('view-dashboard')">Cancelar</button>
                    <button class="btn btn-primary" onclick="validarEtapa1()">Siguiente ‚û°Ô∏è</button>
                </div>
            </div>
        </div>

        <div id="view-etapa2" class="view-section hidden">
            <div class="card">
                <h3>Ubicaci√≥n y Foto</h3>
                
                <label>GPS</label>
                <button type="button" class="btn btn-info" onclick="obtenerUbicacion()">üì° Obtener GPS</button>
                <p id="gpsStatus" class="status-msg" style="color:#666;">No iniciada</p>
                <input type="hidden" id="lat"><input type="hidden" id="lng">

                <div id="manualLocation" class="hidden" style="background:#fff3cd; padding:10px; border-radius:8px; margin-top:10px;">
                    <input type="text" id="linkManual" placeholder="Pega link de Maps si falla el GPS">
                    <button class="btn btn-secondary" style="margin-top:5px;" onclick="usarUbicacionManual()">Guardar Link</button>
                </div>

                <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">

                <label>Fotograf√≠a</label>
                <div style="background: #e9ecef; padding: 10px; border-radius: 8px; font-size: 0.85em; margin-bottom: 10px;">
                    üì∑ Al tomarla se descargar√° con nombre del Departamento.
                </div>
                <input type="file" id="foto" accept="image/*" capture="environment">
                
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-secondary" onclick="mostrarVista('view-etapa1')">‚¨ÖÔ∏è Volver</button>
                    <button class="btn btn-success" id="btnFinalizar" onclick="guardarClienteFinal()">üíæ Guardar</button>
                </div>
            </div>
        </div>

        <div id="view-reportes" class="view-section hidden">
            <div class="card no-print">
                <h3>Reportes</h3>
                <label>Fecha:</label><input type="date" id="filtroFechaReporte">
                <label>Depto:</label><select id="filtroDeptReporte"><option value="">Todos</option></select>
                <button class="btn btn-primary" onclick="generarReporte()">Generar Tabla</button>
            </div>
            <div class="card" id="areaImpresion">
                <h3 class="text-center">Reporte de Ruta</h3>
                <table id="tablaReporte">
                    <thead><tr><th>Negocio</th><th>Direcci√≥n</th><th>Contacto</th><th>Cita</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="btn btn-secondary no-print" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
        </div>
    </div>

    <div class="nav-bar no-print">
        <button class="nav-btn active" id="btn-nav-home" onclick="mostrarVista('view-dashboard')"><span class="nav-icon">üè†</span>Inicio</button>
        <button class="nav-btn" id="btn-nav-add" onclick="irAEtapa1(true)"><span class="nav-icon">‚ûï</span>Nuevo</button>
        <button class="nav-btn" id="btn-nav-rep" onclick="irAReportes()"><span class="nav-icon">üìä</span>Reportes</button>
    </div>

    <script>
        const deptos = ["Alta Verapaz", "Baja Verapaz", "Chimaltenango", "Chiquimula", "El Progreso", "Escuintla", "Guatemala", "Huehuetenango", "Izabal", "Jalapa", "Jutiapa", "Pet√©n", "Quetzaltenango", "Quich√©", "Retalhuleu", "Sacatep√©quez", "San Marcos", "Santa Rosa", "Solol√°", "Suchitep√©quez", "Totonicap√°n", "Zacapa"];

        document.addEventListener("DOMContentLoaded", () => {
            llenarSelects();
            renderizarTablaDashboard();
            document.getElementById('filtroFechaReporte').valueAsDate = new Date();
        });

        function llenarSelects() {
            ['departamento', 'filtroDeptDash', 'filtroDeptReporte'].forEach(id => {
                const s = document.getElementById(id);
                deptos.forEach(d => { let o = document.createElement('option'); o.value=d; o.textContent=d; s.appendChild(o); });
            });
            document.getElementById('departamento').value = "Guatemala";
        }

        // --- GESTI√ìN DE VISTAS ---
        function mostrarVista(id) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(id === 'view-dashboard') document.getElementById('btn-nav-home').classList.add('active');
            if(id.includes('etapa')) document.getElementById('btn-nav-add').classList.add('active');
            if(id === 'view-reportes') document.getElementById('btn-nav-rep').classList.add('active');
        }

        // --- CREAR / EDITAR ---
        function irAEtapa1(esNuevo = false) {
            if(esNuevo) {
                limpiarFormulario();
                document.getElementById('editandoId').value = ""; // Limpiar ID
                document.getElementById('tituloForm').textContent = "Nuevo Cliente";
                document.getElementById('btnFinalizar').textContent = "üíæ Finalizar";
            }
            mostrarVista('view-etapa1');
        }

        function cargarClienteParaEditar(id) {
            const db = JSON.parse(localStorage.getItem('db_ruta_final')) || [];
            const cliente = db.find(c => c.id == id);
            
            if(cliente) {
                // Cargar datos en inputs
                document.getElementById('editandoId').value = cliente.id;
                document.getElementById('negocio').value = cliente.negocio;
                document.getElementById('departamento').value = cliente.departamento;
                document.getElementById('direccion').value = cliente.direccion;
                document.getElementById('encargado').value = cliente.encargado;
                document.getElementById('telefono').value = cliente.telefono;
                document.getElementById('cita').value = cliente.cita;
                document.getElementById('lat').value = cliente.lat;
                document.getElementById('lng').value = cliente.lng;

                // Actualizar interfaz
                document.getElementById('tituloForm').textContent = "Editando Cliente";
                document.getElementById('btnFinalizar').textContent = "üíæ Actualizar Datos";
                
                // Si tiene GPS, mostrar estado
                if(cliente.lat) {
                    document.getElementById('gpsStatus').textContent = "‚úÖ Coordenadas cargadas";
                    document.getElementById('gpsStatus').style.color = "green";
                }

                mostrarVista('view-etapa1');
            }
        }

        function eliminarCliente(id) {
            if(confirm("¬øEst√°s seguro de borrar este cliente? No se podr√° recuperar.")) {
                let db = JSON.parse(localStorage.getItem('db_ruta_final')) || [];
                db = db.filter(c => c.id != id); // Filtrar el que coincida
                localStorage.setItem('db_ruta_final', JSON.stringify(db));
                renderizarTablaDashboard();
            }
        }

        // --- L√ìGICA ---
        function validarEtapa1() {
            if(!document.getElementById('negocio').value) return alert("Falta Nombre Negocio");
            mostrarVista('view-etapa2');
        }

        function guardarClienteFinal() {
            const editandoId = document.getElementById('editandoId').value;
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;

            if(!lat && !editandoId && !confirm("¬øGuardar sin GPS?")) return;

            const datosCliente = {
                id: editandoId ? parseInt(editandoId) : Date.now(), // Si edita usa su ID, si es nuevo crea uno
                negocio: document.getElementById('negocio').value,
                departamento: document.getElementById('departamento').value,
                direccion: document.getElementById('direccion').value,
                encargado: document.getElementById('encargado').value,
                telefono: document.getElementById('telefono').value,
                cita: document.getElementById('cita').value,
                lat: lat, lng: lng,
                fecha: new Date().toISOString().split('T')[0] // Mantiene fecha hoy al editar, opcional cambiar
            };

            let db = JSON.parse(localStorage.getItem('db_ruta_final')) || [];

            if(editandoId) {
                // ACTUALIZAR
                const index = db.findIndex(c => c.id == editandoId);
                if(index !== -1) db[index] = datosCliente;
                alert("‚úÖ Datos Actualizados");
            } else {
                // NUEVO
                db.push(datosCliente);
                alert("‚úÖ Registro Creado");
            }

            localStorage.setItem('db_ruta_final', JSON.stringify(db));
            limpiarFormulario();
            mostrarVista('view-dashboard');
            renderizarTablaDashboard();
        }

        // --- GPS y FOTO ---
        function obtenerUbicacion() {
            const status = document.getElementById('gpsStatus');
            const manual = document.getElementById('manualLocation');
            status.textContent = "üì° Buscando...";
            
            if (!navigator.geolocation) { manual.classList.remove('hidden'); return; }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById('lat').value = pos.coords.latitude;
                    document.getElementById('lng').value = pos.coords.longitude;
                    status.textContent = `‚úÖ Listo: ${pos.coords.accuracy.toFixed(0)}m`;
                    status.style.color = "green";
                    manual.classList.add('hidden');
                },
                () => { manual.classList.remove('hidden'); status.textContent = "‚ùå Fall√≥"; },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function usarUbicacionManual() {
            const link = document.getElementById('linkManual').value;
            if(link.length > 5) {
                document.getElementById('lat').value = "MANUAL";
                document.getElementById('lng').value = link;
                document.getElementById('gpsStatus').textContent = "‚úÖ Link Manual OK";
            }
        }

        document.getElementById('foto').addEventListener('change', function(e) {
            if(e.target.files[0]) {
                const depto = document.getElementById('departamento').value.toUpperCase().replace(/\s/g, '');
                const neg = document.getElementById('negocio').value.replace(/\s/g, '_') || 'CLIENTE';
                const link = document.createElement('a');
                link.href = URL.createObjectURL(e.target.files[0]);
                link.download = `${depto}_${neg}_${new Date().toISOString().slice(0,10)}.jpg`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }
        });

        // --- UTILIDADES ---
        function renderizarTablaDashboard() {
            const db = JSON.parse(localStorage.getItem('db_ruta_final')) || [];
            const filtro = document.getElementById('filtroDeptDash').value;
            const tbody = document.querySelector('#tablaDashboard tbody');
            const msg = document.getElementById('emptyMsg');
            tbody.innerHTML = '';

            const filtrados = db.filter(c => !filtro || c.departamento === filtro);
            
            if(filtrados.length === 0) { msg.style.display = 'block'; return; }
            msg.style.display = 'none';

            filtrados.forEach(c => {
                // Link mapa
                let mapBtn = '';
                if(c.lat && c.lat !== "MANUAL") {
                    mapBtn = `<a href="https://www.google.com/maps?q=${c.lat},${c.lng}" target="_blank" class="btn-sm btn-info" style="text-decoration:none">üó∫Ô∏è</a>`;
                } else if (c.lat === "MANUAL") {
                    mapBtn = `<a href="${c.lng}" target="_blank" class="btn-sm btn-info" style="text-decoration:none">üó∫Ô∏è</a>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td><b>${c.negocio}</b><br><small>${c.encargado}</small></td>
                        <td>${c.departamento}</td>
                        <td style="text-align:center; white-space:nowrap;">
                            ${mapBtn}
                            <button class="btn btn-sm btn-edit" onclick="cargarClienteParaEditar(${c.id})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-del" onclick="eliminarCliente(${c.id})">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        }

        function limpiarFormulario() {
            document.querySelectorAll('input').forEach(i => i.value = '');
            document.getElementById('gpsStatus').textContent = 'No iniciada';
            document.getElementById('gpsStatus').style.color = '#666';
            document.getElementById('departamento').value = "Guatemala";
        }

        function generarReporte() {
            const db = JSON.parse(localStorage.getItem('db_ruta_final')) || [];
            const fDate = document.getElementById('filtroFechaReporte').value;
            const fDept = document.getElementById('filtroDeptReporte').value;
            const t = document.querySelector('#tablaReporte tbody');
            t.innerHTML = '';

            db.filter(c => (!fDate || c.fecha === fDate) && (!fDept || c.departamento === fDept))
              .forEach(c => {
                  t.innerHTML += `<tr><td>${c.negocio}<br><small>(${c.departamento})</small></td><td>${c.direccion}</td><td>${c.encargado}<br>${c.telefono}</td><td>${c.cita ? c.cita.replace('T', ' ') : '-'}</td></tr>`;
              });
        }
        
        function agendarCalendario() {
            const val = document.getElementById('cita').value;
            if(!val) return alert("Pon fecha");
            const d = new Date(val).toISOString().replace(/-|:|\.\d\d\d/g, "");
            window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(document.getElementById('negocio').value)}&dates=${d}/${d}`, '_blank');
        }
        function irAReportes() { mostrarVista('view-reportes'); }
    </script>
</body>
</html>

