<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1565c0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ruta Comercial GT v10</title>
    
    <style>
        /* ESTILOS BASE */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f2f4f8; 
            margin: 0; 
            padding: 0; 
            padding-bottom: 80px; 
            -webkit-tap-highlight-color: transparent;
        }
        
        header { 
            background: linear-gradient(135deg, #0d47a1 0%, #1565c0 100%); 
            color: white; 
            padding: 12px 15px; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            width: 100%; 
        }
        .header-info { 
            flex: 1; 
        }
        .app-title { 
            font-weight: bold; 
            font-size: 1.1em; 
            margin-bottom: 3px; 
        }
        .header-date { 
            font-size: 0.8em; 
            opacity: 0.9; 
            margin-bottom: 5px;
        }
        .header-buttons { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 10px; 
        }
        .card { 
            background: white; 
            padding: 18px; 
            border-radius: 12px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.08); 
            margin-bottom: 15px; 
            border: 1px solid #e8ecf1; 
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
        }
        .card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        }
        
        h3 { 
            margin-top: 0; 
            color: #2c3e50; 
            border-bottom: 2px solid #f0f2f5; 
            padding-bottom: 10px; 
            font-size: 1.1em; 
        }
        label { 
            font-weight: 600; 
            font-size: 0.85em; 
            color: #5f6368; 
            display: block; 
            margin-top: 12px; 
        }
        
        /* Inputs mejorados */
        input, select { 
            width: 100%; 
            padding: 12px; 
            margin-top: 5px; 
            border: 1.5px solid #d1d9e6; 
            border-radius: 8px; 
            font-size: 16px; 
            background-color: #fff; 
            height: 45px; 
            transition: border-color 0.3s; 
            box-sizing: border-box;
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #1976d2; 
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1); 
        }
        
        /* BOTONES mejorados */
        .btn { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 15px; 
            font-weight: 600; 
            letter-spacing: 0.3px; 
            margin-top: 15px; 
            color: white; 
            transition: 0.2s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .btn:active { 
            transform: scale(0.97); 
        }
        .btn-primary { 
            background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%); 
        }
        .btn-success { 
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%); 
        }
        .btn-secondary { 
            background: linear-gradient(135deg, #757575 0%, #9e9e9e 100%); 
        }
        .btn-warning { 
            background: linear-gradient(135deg, #fbc02d 0%, #ffeb3b 100%); 
            color: #333; 
        }
        .btn-danger { 
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%); 
        }
        .btn-dark { 
            background: linear-gradient(135deg, #263238 0%, #455a64 100%); 
        }
        .btn-info { 
            background: linear-gradient(135deg, #0288d1 0%, #03a9f4 100%); 
        }
        .btn-cloud-up {
            background: linear-gradient(135deg, #5c6bc0 0%, #3f51b5 100%);
        }
        .btn-cloud-down {
            background: linear-gradient(135deg, #ff7043 0%, #f4511e 100%);
        }

        /* Botones Peque√±os */
        .btn-icon { 
            padding: 6px 10px; 
            border-radius: 6px; 
            border: none; 
            cursor: pointer; 
            color: white; 
            margin-left: 2px; 
            font-size: 14px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
        }
        
        /* Checkbox */
        .check-ruta { 
            width: 24px; 
            height: 24px; 
            margin-right: 12px; 
            vertical-align: middle; 
            accent-color: #1976d2; 
        }

        /* MEN√ö INFERIOR mejorado */
        .nav-bar { 
            display: flex; 
            justify-content: space-around; 
            background: white; 
            padding: 8px 0; 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            border-top: 1px solid #ddd; 
            z-index: 1000; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
        }
        .nav-btn { 
            background: none; 
            border: none; 
            color: #5f6368; 
            font-size: 10px; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 20%; 
            position: relative; 
            transition: color 0.3s; 
        }
        .nav-btn.active { 
            color: #1565c0; 
            font-weight: bold; 
        }
        .nav-icon { 
            font-size: 22px; 
            margin-bottom: 2px; 
        }
        .badge { 
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%); 
            color: white; 
            border-radius: 50%; 
            padding: 3px 6px; 
            font-size: 10px; 
            position: absolute; 
            top: -2px; 
            right: 15%; 
            font-weight: bold; 
            min-width: 18px; 
            text-align: center; 
        }
        .notification-dot { 
            width: 8px; 
            height: 8px; 
            background: #ff4757; 
            border-radius: 50%; 
            position: absolute; 
            top: 2px; 
            right: 20%; 
        }

        /* ETIQUETAS mejoradas */
        .tag-visited { 
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); 
            color: #2e7d32; 
            padding: 4px 10px; 
            border-radius: 20px; 
            font-size: 0.75em; 
            font-weight: bold; 
            border: 1px solid #a5d6a7; 
            display: inline-block; 
            margin-top: 5px; 
        }
        .tag-dept { 
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
            color: #1565c0; 
            padding: 4px 10px; 
            border-radius: 20px; 
            font-size: 0.75em; 
            font-weight: bold; 
            text-transform: uppercase; 
            border: 1px solid #90caf9; 
        }

        /* TABLA REPORTES mejorada */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.8em; 
            margin-top: 10px; 
            border-radius: 8px; 
            overflow: hidden; 
        }
        th, td { 
            border: 1px solid #e0e0e0; 
            padding: 10px; 
            text-align: left; 
        }
        th { 
            background: linear-gradient(135deg, #f5f5f5 0%, #eeeeee 100%); 
            font-weight: bold; 
            color: #333; 
        }
        .hidden { 
            display: none !important; 
        }

        /* Checkboxes de contacto mejorados */
        .contact-options { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            margin-top: 10px; 
        }
        .contact-option { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 12px; 
            border-radius: 8px; 
            background: #f8f9fa; 
        }
        .contact-option input[type="checkbox"] { 
            width: 20px; 
            height: 20px; 
            accent-color: #1976d2; 
        }
        .contact-label { 
            font-size: 0.85em; 
            color: #333; 
            font-weight: 500; 
        }

        /* Colores para las opciones de contacto */
        .whatsapp-option { 
            border-left: 4px solid #25D366; 
        }
        .call-option { 
            border-left: 4px solid #4285F4; 
        }
        .other-option { 
            border-left: 4px solid #757575; 
        }

        /* Buscador mejorado */
        .search-container { 
            position: relative; 
            margin-top: 10px; 
        }
        .search-icon { 
            position: absolute; 
            left: 12px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #666; 
            font-size: 1.1em; 
        }
        .search-input { 
            padding-left: 40px !important; 
            background: #f8f9fa; 
            border: 1px solid #e0e0e0; 
        }

        /* Indicador de optimizaci√≥n mejorado */
        .route-optimized { 
            background: linear-gradient(135deg, #e8f5e9 0%, #d7eed9 100%) !important; 
            border-left: 5px solid #2e7d32 !important; 
        }
        .route-distance { 
            font-size: 0.8em; 
            color: #666; 
            margin-left: 5px; 
            font-weight: 500; 
        }

        /* Calendario */
        .calendar-day { 
            background: #e3f2fd; 
            padding: 5px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
        }
        .calendar-appointment { 
            background: white; 
            padding: 10px; 
            border-radius: 6px; 
            margin: 5px 0; 
            border-left: 4px solid #1976d2; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        .calendar-appointment.urgent { 
            border-left-color: #f44336; 
        }
        .calendar-appointment.upcoming { 
            border-left-color: #ff9800; 
        }

        /* Estad√≠sticas */
        .stats-container { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        .stat-card { 
            flex: 1; 
            background: white; 
            padding: 12px; 
            border-radius: 8px; 
            text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .stat-number { 
            font-size: 1.5em; 
            font-weight: bold; 
            color: #1976d2; 
        }
        .stat-label { 
            font-size: 0.8em; 
            color: #666; 
        }

        /* Modal de notificaci√≥n */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 2000; 
            justify-content: center; 
            align-items: center; 
        }
        .modal-content { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            max-width: 400px; 
            width: 90%; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }
        .modal-header { 
            font-weight: bold; 
            font-size: 1.2em; 
            margin-bottom: 10px; 
            color: #333; 
        }
        .modal-body { 
            margin-bottom: 15px; 
        }
        .modal-footer { 
            text-align: right; 
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 300px;
        }
        
        .toast.success {
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
        }
        
        .toast.warning {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
            color: #333;
        }
        
        .toast.info {
            background: linear-gradient(135deg, #0288d1 0%, #03a9f4 100%);
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* PWA Install Button */
        .install-btn {
            background: linear-gradient(135deg, #FF4081 0%, #F50057 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        /* Selector de departamento en header con checkboxes */
        .dept-filter-container {
            position: relative;
            display: inline-block;
            margin-top: 5px;
            z-index: 1100;
        }

        .dept-selector-header {
            font-size: 0.75em !important;
            padding: 6px 12px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
            background: rgba(255,255,255,0.1) !important;
            color: white !important;
            height: 32px !important;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dept-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1100;
            min-width: 250px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 5px;
        }

        .dept-dropdown-header {
            padding: 12px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }

        .close-dropdown {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dept-checkboxes-container {
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .dept-checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .dept-checkbox-item:last-child {
            border-bottom: none;
        }

        .dept-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            accent-color: #1976d2;
        }

        .dept-checkbox-item label {
            margin: 0;
            font-size: 0.9em;
            color: #333;
            cursor: pointer;
            flex: 1;
        }

        .dept-dropdown-footer {
            padding: 12px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 8px;
            background: #f9f9f9;
            border-radius: 0 0 8px 8px;
        }

        .dept-selected-badge {
            background: #2196f3;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.7em;
            margin-left: 5px;
            font-weight: bold;
        }

        /* Indicador de sincronizaci√≥n */
        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7em;
            color: #ddd;
            margin-top: 3px;
        }

        .sync-indicator .sync-icon {
            font-size: 0.8em;
        }

        .sync-indicator.syncing {
            color: #ff9800;
        }

        .sync-indicator.success {
            color: #4caf50;
        }

        .sync-indicator.error {
            color: #f44336;
        }

        .last-sync {
            font-size: 0.7em;
            color: #aaa;
            margin-top: 2px;
        }

        /* Estilos para formulario sim√©trico */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }
        
        .input-symmetric {
            width: 100%;
            height: 45px;
            padding: 10px 12px;
            border: 1.5px solid #d1d9e6;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: #fff;
            transition: border-color 0.3s;
        }
        
        .input-symmetric:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        /* Reloj en tiempo real */
        .real-time-clock {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #2196f3;
            font-weight: bold;
            margin-top: 2px;
        }

        @media print {
            .no-print, .nav-bar, header { display: none !important; }
            .card { box-shadow: none; border: none; padding: 0; margin: 0; }
            body { background: white; padding: 0; }
        }
    </style>
</head>
<body>

    <header class="no-print">
        <div class="header-content">
            <div class="header-info">
                <div class="app-title">Ruta Comercial GT v10</div>
                <div id="fecha-header" class="header-date"></div>
                <div id="real-time-clock" class="real-time-clock"></div>
                
                <!-- Dropdown con checkboxes para selecci√≥n m√∫ltiple de departamentos -->
                <div class="dept-filter-container">
                    <button class="dept-selector-header" onclick="toggleDeptDropdown()">
                        üìã Filtrar Departamentos
                    </button>
                    
                    <div id="deptDropdown" class="dept-dropdown hidden">
                        <div class="dept-dropdown-header">
                            <strong>Seleccione Departamentos:</strong>
                            <button onclick="toggleDeptDropdown()" class="close-dropdown">√ó</button>
                        </div>
                        
                        <div class="dept-checkboxes-container">
                            <!-- Los checkboxes se generar√°n con JavaScript -->
                        </div>
                        
                        <div class="dept-dropdown-footer">
                            <button class="btn btn-primary" onclick="aplicarFiltroDepartamentos()" style="padding: 8px 12px; font-size: 12px;">
                                ‚úÖ Aplicar
                            </button>
                            <button class="btn btn-secondary" onclick="limpiarFiltroDepartamentos()" style="padding: 8px 12px; font-size: 12px;">
                                üóëÔ∏è Limpiar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="sync-indicator" id="syncIndicator">
                    <span class="sync-icon">üîÑ</span>
                    <span id="syncStatus">√öltima sincronizaci√≥n: Nunca</span>
                </div>
            </div>
            <div class="header-buttons">
                <button class="install-btn" id="installButton">üì≤ Instalar App</button>
                <span id="notificacion-badge" class="badge hidden">0</span>
                <button class="btn-icon btn-warning" onclick="limpiarRuta()" style="font-size:11px; padding:5px 8px; color:black; font-weight:bold;">Limpiar Ruta</button>
            </div>
        </div>
    </header>

    <div class="toast-container" id="toastContainer"></div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üîî Recordatorio de Cita</div>
            <div class="modal-body" id="modalBody">
                Tienes una cita pr√≥xima.
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal()">Cerrar</button>
                <button class="btn btn-primary" onclick="verCalendario()">Ver Calendario</button>
            </div>
        </div>
    </div>

    <div class="container">

        <div id="view-dashboard" class="view-section">
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="statTotal">0</div>
                    <div class="stat-label">Total Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statHoy">0</div>
                    <div class="stat-label">Visitados Hoy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statCitas">0</div>
                    <div class="stat-label">Citas Hoy</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="nuevoCliente()">+ AGREGAR CLIENTE NUEVO</button>
            
            <div class="card" style="margin-top:15px;">
                <h3>Cartera de Clientes</h3>
                
                <label style="margin-top:0;">Filtrar por Departamento:</label>
                <select id="filtroDeptDash" onchange="renderDashboard()">
                    <option value="">Mostrar Todos</option>
                    <option value="multiple">M√∫ltiples Departamentos</option>
                </select>
                
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="buscadorDashboard" class="search-input" placeholder="Buscar por negocio, tel√©fono o encargado..." oninput="renderDashboard()">
                </div>

                <div id="listaClientes" style="margin-top:15px;"></div>
                <p id="msgVacio" style="text-align:center; color:#777; padding:20px; display:none;">No hay clientes registrados.</p>
            </div>
        </div>

        <div id="view-ruta" class="view-section hidden">
            <div class="card" style="background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border:1px solid #90caf9;">
                <h3 style="color:#1565c0; border:none;">üìç Ruta del D√≠a</h3>
                <p id="txtRuta" style="font-size:0.9em; color:#555;">Selecciona clientes en el inicio para armar tu ruta.</p>
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-primary" style="background:#0277bd; flex: 1;" onclick="abrirMapaRuta()">üó∫Ô∏è Abrir Ruta en Google Maps</button>
                    <button class="btn btn-success" style="flex: 1;" onclick="optimizarRuta()">üî¢ Optimizar Ruta por Proximidad</button>
                </div>
                
                <div style="margin-top: 10px; font-size: 0.8em; color: #666;">
                    <span id="rutaInfo">0 clientes en ruta</span>
                    <span id="distanciaTotal" style="margin-left: 10px;"></span>
                </div>
            </div>
            <div id="listaRutaContainer"></div>
        </div>

        <div id="view-form" class="view-section hidden">
            <div class="card">
                <h3 id="tituloForm">Datos Cliente</h3>
                <input type="hidden" id="idCliente">
                <input type="hidden" id="flagRuta" value="0">
                
                <div class="form-group">
                    <label>Negocio / Cliente *</label>
                    <input type="text" id="negocio" class="input-symmetric" placeholder="Nombre del local" oninput="marcarFormularioModificado()">
                </div>

                <div class="form-group">
                    <label>Departamento *</label>
                    <select id="departamento" class="input-symmetric" onchange="cargarMunicipiosPorDepartamento(this.value); marcarFormularioModificado()">
                    </select>
                </div>

                <div class="form-group">
                    <label>Municipio</label>
                    <select id="municipio" class="input-symmetric" onchange="marcarFormularioModificado()">
                        <option value="">Seleccionar Municipio</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Direcci√≥n (Referencia)</label>
                    <input type="text" id="direccion" class="input-symmetric" placeholder="Ej: Frente al parque..." oninput="marcarFormularioModificado()">
                </div>

                <div class="form-group">
                    <label>Encargado</label>
                    <input type="text" id="encargado" class="input-symmetric" oninput="marcarFormularioModificado()">
                </div>

                <div class="form-group">
                    <label>Tel√©fono * (8 d√≠gitos)</label>
                    <input type="tel" id="telefono" class="input-symmetric" maxlength="8" pattern="[0-9]{8}" placeholder="12345678" 
                           oninput="formatearTelefono(this); marcarFormularioModificado()">
                </div>
                
                <div class="form-group">
                    <label>Opciones de Contacto</label>
                    <div class="contact-options">
                        <div class="contact-option whatsapp-option">
                            <input type="checkbox" id="contactoWhatsApp" value="whatsapp" onchange="marcarFormularioModificado()">
                            <label class="contact-label" for="contactoWhatsApp">WhatsApp</label>
                        </div>
                        <div class="contact-option call-option">
                            <input type="checkbox" id="contactoLlamada" value="llamada" onchange="marcarFormularioModificado()">
                            <label class="contact-label" for="contactoLlamada">Llamada</label>
                        </div>
                        <div class="contact-option other-option">
                            <input type="checkbox" id="contactoOtro" value="otro" onchange="marcarFormularioModificado()">
                            <label class="contact-label" for="contactoOtro">Otro</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Mensaje para WhatsApp</label>
                    <input type="text" id="mensajeWhatsApp" class="input-symmetric" placeholder="Mensaje personalizado (opcional)" oninput="marcarFormularioModificado()">
                </div>
                
                <div class="form-group">
                    <label>Pr√≥xima Cita / Recordatorio</label>
                    <input type="datetime-local" id="cita" class="input-symmetric" oninput="marcarFormularioModificado()">
                </div>
                
                <div class="form-group">
                    <label>Opciones de Contacto para la Cita</label>
                    <div class="contact-options">
                        <div class="contact-option whatsapp-option">
                            <input type="checkbox" id="citaWhatsApp" value="whatsapp" onchange="marcarFormularioModificado()">
                            <label class="contact-label" for="citaWhatsApp">Recordatorio por WhatsApp</label>
                        </div>
                        <div class="contact-option call-option">
                            <input type="checkbox" id="citaLlamada" value="llamada" onchange="marcarFormularioModificado()">
                            <label class="contact-label" for="citaLlamada">Recordatorio por Llamada</label>
                        </div>
                        <div class="contact-option other-option">
                            <input type="checkbox" id="citaOtro" value="otro" onchange="marcarFormularioModificado()">
                            <label class="contact-label" for="citaOtro">Otro m√©todo</label>
                        </div>
                    </div>
                </div>

                <button class="btn btn-warning" onclick="agendarCal()">üìÖ Agendar en Calendar</button>

                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn btn-secondary" onclick="volverConConfirmacion()">Cancelar</button>
                    <button class="btn btn-primary" onclick="irGPS()">Siguiente ‚û°Ô∏è</button>
                </div>
            </div>
        </div>

        <div id="view-gps" class="view-section hidden">
            <div class="card">
                <h3>Ubicaci√≥n y Foto</h3>
                <button class="btn btn-primary" onclick="obtenerGPS()">üì° Obtener GPS</button>
                <p id="gpsTxt" style="font-size:0.9em; margin-top:5px; color:#555; font-weight:bold;">Esperando...</p>
                <input type="hidden" id="lat"><input type="hidden" id="lng">
                
                <div id="boxManual" class="hidden" style="margin-top:10px;">
                    <input type="text" id="linkMan" placeholder="Pegar link de Maps aqu√≠">
                    <button class="btn btn-secondary" onclick="usarManual()">Usar Link</button>
                </div>
                <hr>
                <label>Foto Evidencia</label>
                <div style="background:#eee; padding:5px; font-size:0.8em; border-radius:4px; margin-bottom:5px;">‚ÑπÔ∏è Se descargar√° con nombre del Depto y Fecha.</div>
                <input type="file" id="foto" accept="image/*" capture="environment">

                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn btn-secondary" onclick="mostrar('view-form')">‚¨ÖÔ∏è Volver</button>
                    <button class="btn btn-success" id="btnFin" onclick="guardar()">üíæ FINALIZAR</button>
                </div>
            </div>
        </div>

        <div id="view-calendar" class="view-section hidden">
            <div class="card">
                <h3>üìÖ Agenda de Citas</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="date" id="fechaCalendario" style="flex:1;" onchange="filtrarCitas()">
                    <button class="btn btn-secondary" onclick="filtrarCitasHoy()">Hoy</button>
                    <button class="btn btn-primary" onclick="filtrarCitasMes()">Este Mes</button>
                </div>
                <div id="listaCitas"></div>
                <p id="msgSinCitas" style="text-align:center; color:#777; padding:20px; display:none;">No hay citas programadas para esta fecha.</p>
            </div>
        </div>

        <div id="view-reportes" class="view-section hidden">
            
            <div class="card no-print" style="border-left: 5px solid #3f51b5; background: #e8eaf6;">
                <h3 style="color:#283593;">‚òÅÔ∏è Sincronizaci√≥n en la Nube (Google)</h3>
                <p style="font-size:0.85em; color:#555; margin-bottom:15px;">
                    Gestiona tus datos entre dispositivos. <strong>Nota:</strong> Se crear√° un respaldo local autom√°tico antes de cualquier acci√≥n.
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-cloud-up" style="flex: 1;" onclick="sincronizarDrive()">
                        ‚òÅÔ∏è‚¨ÜÔ∏è SUBIR DATOS A LA NUBE
                    </button>
                    <button class="btn btn-cloud-down" style="flex: 1;" onclick="descargarDeDrive()">
                        ‚òÅÔ∏è‚¨áÔ∏è RESTAURAR DESDE NUBE
                    </button>
                </div>
                <div class="sync-indicator" style="margin-top: 10px; font-size: 0.8em;">
                    <span>Auto-sync: Cada 10 minutos | Acciones cr√≠ticas</span>
                </div>
            </div>

            <div class="card no-print">
                <h3>Generador de Reportes</h3>
                <p style="font-size:0.9em; color:#555;">Selecciona el informe:</p>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <button class="btn btn-success" style="flex: 1;" onclick="reporteDiario()">üìÑ REPORTE VISITAS DEL D√çA</button>
                    <button class="btn btn-dark" style="flex: 1;" onclick="reporteTotal()">üìÇ CARTERA TOTAL DE CLIENTES</button>
                </div>
                
                <hr style="margin:20px 0;">
                
                <label>Filtros Manuales:</label>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="repFecha">
                    <select id="filtroDeptReporte">
                        <option value="">Todo Depto</option>
                        </select>
                </div>
                <button class="btn btn-primary" onclick="reporteCustom()">üîç Buscar</button>
            </div>

            <div class="card" id="areaPrint">
                <div style="text-align:center; margin-bottom:15px;">
                    <h2 id="tituloReporte" style="margin:0; color:#333;">REPORTE</h2>
                    <p id="subtituloReporte" style="margin:0; font-size:0.9em; color:#666;"></p>
                </div>

                <div style="overflow-x:auto;">
                    <table id="tablaRep">
                        <thead>
                            <tr style="background:#eee;">
                                <th>Cliente</th>
                                <th>Ubicaci√≥n / Contacto</th>
                                <th>Preferencias</th>
                                <th>Gesti√≥n</th>
                                <th class="no-print">Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="resumenReporte" style="margin-top:15px; font-weight:bold; text-align:right;"></div>
            </div>

            <div class="no-print" style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è IMPRIMIR / PDF</button>
                <button class="btn btn-info" onclick="exportarCSV()">üì• EXPORTAR A CSV</button>
                <button class="btn btn-warning" onclick="realizarBackupManual()">üíæ BACKUP MANUAL</button>
            </div>
            
            <!-- Bot√≥n de eliminar todo al final -->
            <div class="card no-print" style="margin-top: 20px; border-left: 5px solid #d32f2f; background: #ffebee;">
                <h3 style="color:#c62828;">‚ö†Ô∏è Eliminaci√≥n Masiva</h3>
                <p style="font-size:0.85em; color:#555; margin-bottom:15px;">
                    Esta acci√≥n eliminar√° permanentemente todos los clientes que coincidan con los filtros actuales del reporte.
                </p>
                <button class="btn btn-danger" onclick="eliminarTodosDelReporte()">
                    üóëÔ∏è ELIMINAR TODOS LOS REGISTROS VISIBLES
                </button>
                <p style="font-size: 0.8em; color: #d32f2f; margin-top: 10px;">
                    ‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n NO se puede deshacer. Se recomienda hacer un backup primero.
                </p>
            </div>
        </div>

    </div>

    <div class="nav-bar no-print">
        <button class="nav-btn active" id="btn-home" onclick="mostrar('view-dashboard')"><span class="nav-icon">üè†</span>Inicio</button>
        <button class="nav-btn" id="btn-ruta" onclick="mostrar('view-ruta')"><span class="nav-icon">üöö</span>Ruta<span id="badge" class="badge hidden">0</span></button>
        <button class="nav-btn" id="btn-cal" onclick="mostrar('view-calendar')"><span class="nav-icon">üìÖ</span>Calendario<span id="badge-cal" class="badge hidden">0</span></button>
        <button class="nav-btn" id="btn-add" onclick="nuevoCliente()"><span class="nav-icon">‚ûï</span>Crear</button>
        <button class="nav-btn" id="btn-rep" onclick="mostrar('view-reportes')"><span class="nav-icon">üìä</span>Reportes</button>
    </div>

    <script>
        // --- CONSTANTES Y VARIABLES GLOBALES ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxr8HAvy4awBDx67QFy0hUUu2UUtCA1__s5_uFZ2fCh5gi1UNQkypWRCYh1gRRmCmCB/exec";
        
        const LISTA_DEPARTAMENTOS = [
            "Alta Verapaz", "Baja Verapaz", "Chimaltenango", "Chiquimula", "El Progreso", 
            "Escuintla", "Guatemala", "Huehuetenango", "Izabal", "Jalapa", "Jutiapa", 
            "Pet√©n", "Quetzaltenango", "Quich√©", "Retalhuleu", "Sacatep√©quez", "San Marcos", 
            "Santa Rosa", "Solol√°", "Suchitep√©quez", "Totonicap√°n", "Zacapa"
        ];
        
        // Datos completos de municipios por departamento (Todos los municipios de Guatemala)
        const MUNICIPIOS_POR_DEPARTAMENTO = {
            "Alta Verapaz": ["Cob√°n", "Santa Cruz Verapaz", "San Crist√≥bal Verapaz", "Tactic", "Tamah√∫", "San Miguel Tucur√∫", "Panz√≥s", "Senah√∫", "San Pedro Carch√°", "San Juan Chamelco", "Lanqu√≠n", "Chahal", "Fray Bartolom√© de las Casas", "Chisec", "Santa Catarina La Tinta", "Raxruh√°"],
            "Baja Verapaz": ["Salam√°", "San Miguel Chicaj", "Rabinal", "Cubulco", "Granados", "Santa Cruz el Chol", "San Jer√≥nimo", "Purulh√°"],
            "Chimaltenango": ["Chimaltenango", "San Jos√© Poaquil", "San Mart√≠n Jilotepeque", "San Juan Comalapa", "Santa Apolonia", "Tecp√°n Guatemala", "Patz√∫n", "San Miguel Pochuta", "Patzic√≠a", "Santa Cruz Balany√°", "Acatenango", "San Pedro Yepocapa", "San Andr√©s Itzapa", "Parramos", "Zaragoza", "El Tejar", "San Antonio Aguas Calientes", "Santa Catarina Barahona"],
            "Chiquimula": ["Chiquimula", "San Jos√© La Arada", "San Juan Ermita", "Jocot√°n", "Camot√°n", "Olopa", "Esquipulas", "Concepci√≥n Las Minas", "Quezaltepeque", "San Jacinto", "Ipala"],
            "El Progreso": ["Guastatoya", "Moraz√°n", "San Agust√≠n Acasaguastl√°n", "San Crist√≥bal Acasaguastl√°n", "El J√≠caro", "Sansare", "Sanarate", "San Antonio La Paz"],
            "Escuintla": ["Escuintla", "Santa Luc√≠a Cotzumalguapa", "La Democracia", "Siquinal√°", "Masagua", "Tiquisate", "La Gomera", "Guanagazapa", "San Jos√©", "Iztapa", "Pal√≠n", "San Vicente Pacaya", "Nueva Concepci√≥n"],
            "Guatemala": ["Guatemala", "Santa Catarina Pinula", "San Jos√© Pinula", "San Jos√© del Golfo", "Palencia", "Chinautla", "San Pedro Ayampuc", "Mixco", "San Pedro Sacatep√©quez", "San Juan Sacatep√©quez", "San Raymundo", "Chuarrancho", "Fraijanes", "Amatitl√°n", "Villa Nueva", "Villa Canales", "San Miguel Petapa", "Santa Luc√≠a Milpas Altas", "Magdalena Milpas Altas", "Santa Mar√≠a de Jes√∫s", "Ciudad Vieja", "San Antonio Aguas Calientes", "San Bartolom√© Milpas Altas"],
            "Huehuetenango": ["Huehuetenango", "Chiantla", "Malacatancito", "Cuilco", "Nent√≥n", "San Pedro Necta", "Jacaltenango", "San Pedro Soloma", "San Ildefonso Ixtahuac√°n", "Santa B√°rbara", "La Libertad", "La Democracia", "San Miguel Acat√°n", "San Rafael La Independencia", "Todos Santos Cuchumat√°n", "San Juan Atit√°n", "Santa Eulalia", "San Mateo Ixtat√°n", "Colotenango", "San Sebasti√°n Huehuetenango", "Tectit√°n", "Concepci√≥n Huista", "San Juan Ixcoy", "San Antonio Huista", "San Sebasti√°n Coat√°n", "Santa Cruz Barillas", "Aguacat√°n", "San Rafael Petzal", "San Gaspar Ixchil", "Santiago Chimaltenango", "Santa Ana Huista", "Uni√≥n Cantinil"],
            "Izabal": ["Puerto Barrios", "Livingston", "El Estor", "Morales", "Los Amates"],
            "Jalapa": ["Jalapa", "San Pedro Pinula", "San Luis Jilotepeque", "San Manuel Chaparr√≥n", "San Carlos Alzatate", "Monjas", "Mataquescuintla"],
            "Jutiapa": ["Jutiapa", "El Progreso", "Santa Catarina Mita", "Agua Blanca", "Asunci√≥n Mita", "Yupiltepeque", "Atescatempa", "Jerez", "El Adelanto", "Zapotitl√°n", "Comapa", "Jalpatagua", "Conguaco", "Moyuta", "Pasaco", "San Jos√© Acatempa", "Quesada"],
            "Pet√©n": ["Flores", "San Jos√©", "San Benito", "San Andr√©s", "La Libertad", "San Francisco", "Santa Ana", "Dolores", "San Luis", "Sayaxch√©", "Melchor de Mencos", "Popt√∫n", "Las Cruces", "El Chal"],
            "Quetzaltenango": ["Quetzaltenango", "Salcaj√°", "Olintepeque", "San Carlos Sija", "Sibilia", "Cabric√°n", "Cajol√°", "San Miguel Siguil√°", "San Juan Ostuncalco", "San Mateo", "Concepci√≥n Chiquirichapa", "San Mart√≠n Sacatep√©quez", "Almolonga", "Cantel", "Huit√°n", "Zunil", "Colomba", "San Francisco La Uni√≥n", "El Palmar", "Coatepeque", "G√©nova", "Flores Costa Cuca", "La Esperanza", "Palestina de Los Altos"],
            "Quich√©": ["Santa Cruz del Quich√©", "Chich√©", "Chinique", "Zacualpa", "Chajul", "Chichicastenango", "Patzit√©", "San Antonio Ilotenango", "San Pedro Jocopilas", "Cun√©n", "San Juan Cotzal", "Joyabaj", "Nebaj", "San Andr√©s Sajcabaj√°", "Uspant√°n", "Sacapulas", "San Bartolom√© Jocotenango", "Canill√°", "Chicam√°n", "Ixc√°n", "Pachalum", "Playa Grande Ixc√°n"],
            "Retalhuleu": ["Retalhuleu", "San Sebasti√°n", "Santa Cruz Mulu√°", "San Mart√≠n Zapotitl√°n", "San Felipe", "San Andr√©s Villa Seca", "Champerico", "Nuevo San Carlos", "El Asintal"],
            "Sacatep√©quez": ["Antigua Guatemala", "Jocotenango", "Pastores", "Sumpango", "Santo Domingo Xenacoj", "Santiago Sacatep√©quez", "San Bartolom√© Milpas Altas", "San Lucas Sacatep√©quez", "Santa Luc√≠a Milpas Altas", "Magdalena Milpas Altas", "Santa Mar√≠a de Jes√∫s", "Ciudad Vieja", "San Miguel Due√±as", "Alotenango", "San Antonio Aguas Calientes", "Santa Catarina Barahona"],
            "San Marcos": ["San Marcos", "San Pedro Sacatep√©quez", "San Antonio Sacatep√©quez", "Comitancillo", "San Miguel Ixtahuac√°n", "Concepci√≥n Tutuapa", "Tacan√°", "Sibinal", "Tajumulco", "Tejutla", "San Rafael Pie de La Cuesta", "Nuevo Progreso", "El Tumbador", "El Rodeo", "Malacat√°n", "Catarina", "Ayutla", "Oc√≥s", "San Pablo", "El Quetzal", "La Reforma", "Pajapita", "Ixchigu√°n", "San Jos√© Ojetenam", "San Crist√≥bal Cucho", "Sipacapa", "Esquipulas Palo Gordo", "R√≠o Blanco", "San Lorenzo"],
            "Santa Rosa": ["Cuilapa", "Barberena", "Santa Rosa de Lima", "Casillas", "San Rafael Las Flores", "Oratorio", "San Juan Tecuaco", "Chiquimulilla", "Taxisco", "Santa Mar√≠a Ixhuat√°n", "Guazacap√°n", "Santa Cruz Naranjo", "Pueblo Nuevo Vi√±as", "Nueva Santa Rosa"],
            "Solol√°": ["Solol√°", "San Jos√© Chacay√°", "Santa Mar√≠a Visitaci√≥n", "Santa Luc√≠a Utatl√°n", "Nahual√°", "Santa Catarina Ixtahuac√°n", "Santa Clara La Laguna", "Concepci√≥n", "San Andr√©s Semetabaj", "Panajachel", "Santa Catarina Palop√≥", "San Antonio Palop√≥", "San Lucas Tolim√°n", "Santa Cruz La Laguna", "San Pablo La Laguna", "San Marcos La Laguna", "San Juan La Laguna", "San Pedro La Laguna", "Santiago Atitl√°n"],
            "Suchitep√©quez": ["Mazatenango", "Cuyotenango", "San Francisco Zapotitl√°n", "San Bernardino", "San Jos√© El √çdolo", "Santo Domingo Suchitep√©quez", "San Lorenzo", "Samayac", "San Pablo Jocopilas", "San Antonio Suchitep√©quez", "San Miguel Pan√°n", "San Gabriel", "Chicacao", "Patulul", "Santa B√°rbara", "San Juan Bautista", "Santo Tom√°s La Uni√≥n", "Zunilito", "Pueblo Nuevo", "R√≠o Bravo"],
            "Totonicap√°n": ["Totonicap√°n", "San Crist√≥bal Totonicap√°n", "San Francisco El Alto", "San Andr√©s Xecul", "Momostenango", "Santa Mar√≠a Chiquimula", "Santa Luc√≠a La Reforma", "San Bartolo"],
            "Zacapa": ["Zacapa", "Estanzuela", "R√≠o Hondo", "Gual√°n", "Teculut√°n", "Usumatl√°n", "Caba√±as", "San Diego", "La Uni√≥n", "Huit√©"]
        };

        // Variables globales
        let db = JSON.parse(localStorage.getItem('db_clientes_v9')) || [];
        let ruta = JSON.parse(localStorage.getItem('db_ruta_v9')) || [];
        let filtrosReporteActual = { tipo: '', fecha: null, depto: null };
        let rutaOptimizada = false;
        let ubicacionActual = null;
        let notificacionInterval = null;
        let deferredPrompt = null;
        let formDirty = false;
        let notificationPermission = false;
        let departamentosSeleccionados = JSON.parse(localStorage.getItem('dept_seleccionados')) || [];
        let syncInterval = null;
        let lastSyncTime = localStorage.getItem('last_sync_time') || null;
        let autoSyncEnabled = localStorage.getItem('auto_sync_enabled') !== 'false'; // Por defecto habilitado

        // --- TOAST NOTIFICATIONS ---
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                <span>${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // --- LOADING OVERLAY ---
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // --- SANITIZACI√ìN DE DATOS ---
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input.replace(/[<>]/g, '').trim();
        }

        function validatePhone(phone) {
            return /^[0-9]{8}$/.test(phone);
        }

        // --- BACKUP AUTOM√ÅTICO ---
        function crearBackupAutomatico() {
            try {
                const backupData = {
                    db_clientes: db,
                    db_ruta: ruta,
                    timestamp: new Date().toISOString(),
                    version: 'v10'
                };
                localStorage.setItem('backup_' + Date.now(), JSON.stringify(backupData));
                
                // Mantener solo √∫ltimos 5 backups
                const keys = Object.keys(localStorage).filter(k => k.startsWith('backup_'));
                if(keys.length > 5) {
                    keys.sort().slice(0, -5).forEach(k => localStorage.removeItem(k));
                }
            } catch(e) {
                console.error("Error en backup:", e);
            }
        }

        function realizarBackupManual() {
            const fecha = new Date().toISOString().replace(/[:.]/g, '-');
            const backupData = {
                clientes: db,
                ruta: ruta,
                fecha: fecha,
                totalClientes: db.length
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_seguridad_${fecha}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('‚úÖ Respaldo de seguridad guardado en dispositivo', 'success');
        }

        // --- PWA INSTALLATION ---
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installButton = document.getElementById('installButton');
            installButton.style.display = 'block';
            
            installButton.addEventListener('click', () => {
                installButton.style.display = 'none';
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showToast('‚úÖ Aplicaci√≥n instalada', 'success');
                    }
                    deferredPrompt = null;
                });
            });
        });

        // --- RELOJ EN TIEMPO REAL ---
        function actualizarRelojTiempoReal() {
            const ahora = new Date();
            const opciones = { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            const horaFormateada = ahora.toLocaleTimeString('es-GT', opciones);
            document.getElementById('real-time-clock').textContent = `üïí ${horaFormateada}`;
        }

        // --- SISTEMA DE SINCRONIZACI√ìN AUTOM√ÅTICA ---
        function iniciarSincronizacionAutomatica() {
            // Detener intervalo anterior si existe
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            // Sincronizar cada 10 minutos (600000 ms)
            syncInterval = setInterval(async () => {
                if (navigator.onLine && autoSyncEnabled && db.length > 0) {
                    await sincronizarAutomaticamente();
                }
            }, 600000); // 10 minutos
            
            // Tambi√©n sincronizar despu√©s de acciones cr√≠ticas
            document.addEventListener('actionCritica', () => {
                if (navigator.onLine && autoSyncEnabled) {
                    setTimeout(() => sincronizarAutomaticamente(), 2000);
                }
            });
        }

        async function sincronizarAutomaticamente() {
            try {
                // No sincronizar si no hay datos
                if (db.length === 0) return;
                
                // Mostrar indicador de sincronizaci√≥n
                const indicator = document.getElementById('syncIndicator');
                indicator.classList.remove('success', 'error');
                indicator.classList.add('syncing');
                indicator.querySelector('#syncStatus').textContent = 'Sincronizando...';
                
                // Crear backup local primero
                crearBackupAutomatico();
                
                // Enviar datos
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8"
                    },
                    body: JSON.stringify({
                        action: 'auto-sync',
                        data: db,
                        timestamp: new Date().toISOString(),
                        totalRecords: db.length
                    })
                });
                
                // Actualizar √∫ltima sincronizaci√≥n
                const now = new Date();
                lastSyncTime = now.toISOString();
                localStorage.setItem('last_sync_time', lastSyncTime);
                
                // Actualizar indicador
                indicator.classList.remove('syncing');
                indicator.classList.add('success');
                indicator.querySelector('#syncStatus').textContent = 
                    `Sincronizado: ${now.toLocaleTimeString('es-GT', {hour: '2-digit', minute: '2-digit'})}`;
                
                console.log('‚úÖ Sincronizaci√≥n autom√°tica exitosa');
                
                // Ocultar indicador despu√©s de 5 segundos
                setTimeout(() => {
                    indicator.classList.remove('success');
                    indicator.querySelector('#syncStatus').textContent = 
                        `√öltima sincronizaci√≥n: ${now.toLocaleTimeString('es-GT', {hour: '2-digit', minute: '2-digit'})}`;
                }, 5000);
                
            } catch (error) {
                console.error('Error en sincronizaci√≥n autom√°tica:', error);
                const indicator = document.getElementById('syncIndicator');
                indicator.classList.remove('syncing');
                indicator.classList.add('error');
                indicator.querySelector('#syncStatus').textContent = 'Error en sincronizaci√≥n';
                
                // Reintentar en 1 minuto
                setTimeout(() => {
                    indicator.classList.remove('error');
                    indicator.querySelector('#syncStatus').textContent = 
                        `√öltima sincronizaci√≥n: ${lastSyncTime ? new Date(lastSyncTime).toLocaleTimeString('es-GT', {hour: '2-digit', minute: '2-digit'}) : 'Nunca'}`;
                }, 3000);
            }
        }

        function actualizarIndicadorSincronizacion() {
            const indicator = document.getElementById('syncIndicator');
            if (lastSyncTime) {
                const lastSync = new Date(lastSyncTime);
                indicator.querySelector('#syncStatus').textContent = 
                    `√öltima sincronizaci√≥n: ${lastSync.toLocaleTimeString('es-GT', {hour: '2-digit', minute: '2-digit'})}`;
            } else {
                indicator.querySelector('#syncStatus').textContent = '√öltima sincronizaci√≥n: Nunca';
            }
        }

        // Disparar evento de acci√≥n cr√≠tica para sincronizaci√≥n
        function dispararAccionCritica() {
            const event = new Event('actionCritica');
            document.dispatchEvent(event);
        }

        // --- INICIALIZACI√ìN ---
        document.addEventListener("DOMContentLoaded", () => {
            cargarDepartamentosEnSelects();
            renderDashboard();
            actualizarBadge();
            actualizarFechaHeader();
            actualizarEstadisticas();
            actualizarBadgeCalendario();
            verificarIntegridadDatos();
            solicitarPermisosNotificaciones();
            cargarCheckboxesDepartamentos();
            actualizarTextoBotonDepartamentos();
            actualizarIndicadorSincronizacion();
            
            // Iniciar reloj en tiempo real
            actualizarRelojTiempoReal();
            setInterval(actualizarRelojTiempoReal, 1000);
            
            // Iniciar sincronizaci√≥n autom√°tica
            iniciarSincronizacionAutomatica();
            
            // Configurar fecha actual en el filtro de reportes
            document.getElementById('repFecha').value = new Date().toISOString().split('T')[0];
            
            // Iniciar verificaci√≥n de recordatorios cada minuto
            iniciarVerificacionRecordatorios();
            verificarRecordatorios();
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('deptDropdown');
                const button = document.querySelector('.dept-selector-header');
                
                if (dropdown && !dropdown.classList.contains('hidden') && 
                    !dropdown.contains(e.target) && 
                    !button.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
            
            // Detectar cambios offline/online
            window.addEventListener('online', () => {
                showToast('‚úÖ Conectado a internet', 'success');
                // Intentar sincronizar al reconectar
                if (autoSyncEnabled && db.length > 0) {
                    setTimeout(() => sincronizarAutomaticamente(), 3000);
                }
            });
            
            window.addEventListener('offline', () => {
                showToast('‚ö†Ô∏è Sin conexi√≥n a internet', 'warning');
            });
            
            // Prevenir recarga accidental
            window.addEventListener('beforeunload', (e) => {
                if (formDirty) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });

        // --- PERMISOS DE NOTIFICACIONES ---
        async function solicitarPermisosNotificaciones() {
            if (!('Notification' in window)) {
                console.log('Este navegador no soporta notificaciones');
                return;
            }
            
            if (Notification.permission === 'granted') {
                notificationPermission = true;
            } else if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                notificationPermission = permission === 'granted';
            }
        }

        function mostrarNotificacionPush(titulo, cuerpo, datos = {}) {
            if (!notificationPermission) return;
            
            const opciones = {
                body: cuerpo,
                icon: 'https://cdn-icons-png.flaticon.com/512/3208/3208720.png',
                badge: 'https://cdn-icons-png.flaticon.com/512/3208/3208720.png',
                tag: 'ruta_comercial',
                renotify: true,
                silent: false,
                data: datos,
                actions: [
                    {
                        action: 'ver',
                        title: 'Ver'
                    },
                    {
                        action: 'cerrar',
                        title: 'Cerrar'
                    }
                ]
            };
            
            const notificacion = new Notification(titulo, opciones);
            
            notificacion.onclick = function() {
                window.focus();
                if (datos.idCliente) {
                    mostrar('view-calendar');
                }
                this.close();
            };
            
            notificacion.onclose = function() {
                console.log('Notificaci√≥n cerrada');
            };
            
            setTimeout(() => notificacion.close(), 10000);
        }

        // --- FUNCIONES DE FECHA Y HORA ---
        function actualizarFechaHeader() {
            const ahora = new Date();
            const opciones = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            const fechaFormateada = ahora.toLocaleDateString('es-GT', opciones);
            document.getElementById('fecha-header').textContent = fechaFormateada;
            
            setTimeout(actualizarFechaHeader, 60000);
        }

        function actualizarEstadisticas() {
            const hoy = new Date().toISOString().split('T')[0];
            
            // Total clientes
            document.getElementById('statTotal').textContent = db.length;
            
            // Visitados hoy
            const visitadosHoy = db.filter(c => c.fecha === hoy).length;
            document.getElementById('statHoy').textContent = visitadosHoy;
            
            // Citas hoy
            const citasHoy = db.filter(c => {
                if(!c.cita) return false;
                const fechaCita = new Date(c.cita);
                const hoyDate = new Date(hoy);
                return fechaCita.getDate() === hoyDate.getDate() &&
                       fechaCita.getMonth() === hoyDate.getMonth() &&
                       fechaCita.getFullYear() === hoyDate.getFullYear();
            }).length;
            document.getElementById('statCitas').textContent = citasHoy;
            
            // Actualizar badge de notificaciones
            const badgeNotif = document.getElementById('notificacion-badge');
            if(citasHoy > 0) {
                badgeNotif.textContent = citasHoy;
                badgeNotif.classList.remove('hidden');
            } else {
                badgeNotif.classList.add('hidden');
            }
        }

        function actualizarBadgeCalendario() {
            const hoy = new Date().toISOString().split('T')[0];
            const citasHoy = db.filter(c => {
                if(!c.cita) return false;
                const fechaCita = new Date(c.cita);
                const hoyDate = new Date(hoy);
                return fechaCita.getDate() === hoyDate.getDate() &&
                       fechaCita.getMonth() === hoyDate.getMonth() &&
                       fechaCita.getFullYear() === hoyDate.getFullYear();
            }).length;
            
            const badgeCal = document.getElementById('badge-cal');
            if(citasHoy > 0) {
                badgeCal.textContent = citasHoy;
                badgeCal.classList.remove('hidden');
            } else {
                badgeCal.classList.add('hidden');
            }
        }

        // --- CALENDARIO Y RECORDATORIOS (CORREGIDO) ---
        function filtrarCitas() {
            const fechaSeleccionada = document.getElementById('fechaCalendario').value;
            mostrarCitas(fechaSeleccionada);
        }

        function filtrarCitasHoy() {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaCalendario').value = hoy;
            mostrarCitas(hoy);
        }

        function filtrarCitasMes() {
            const hoy = new Date();
            const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString().split('T')[0];
            const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0).toISOString().split('T')[0];
            
            mostrarCitas(null, primerDia, ultimoDia);
        }

        function mostrarCitas(fechaEspecifica = null, fechaInicio = null, fechaFin = null) {
            const listaCitas = document.getElementById('listaCitas');
            const msgSinCitas = document.getElementById('msgSinCitas');
            listaCitas.innerHTML = '';
            
            // Obtener todas las citas programadas (las que tienen fecha)
            let citasFiltradas = db.filter(c => c.cita && c.cita.trim() !== '');
            
            if(citasFiltradas.length === 0) {
                msgSinCitas.style.display = 'block';
                msgSinCitas.textContent = 'No hay citas programadas';
                return;
            }
            
            // Convertir fechas a objetos Date para comparaci√≥n
            citasFiltradas.forEach(cita => {
                cita.citaDate = new Date(cita.cita);
            });
            
            // Filtrar por fecha espec√≠fica
            if(fechaEspecifica) {
                const fechaObj = new Date(fechaEspecifica);
                citasFiltradas = citasFiltradas.filter(c => {
                    const fechaCita = new Date(c.cita);
                    return fechaCita.toDateString() === fechaObj.toDateString();
                });
            }
            
            // Filtrar por rango de fechas
            if(fechaInicio && fechaFin) {
                const inicio = new Date(fechaInicio);
                const fin = new Date(fechaFin);
                citasFiltradas = citasFiltradas.filter(c => {
                    const fechaCita = new Date(c.cita);
                    return fechaCita >= inicio && fechaCita <= fin;
                });
            }
            
            // Ordenar por fecha m√°s cercana
            citasFiltradas.sort((a, b) => new Date(a.cita) - new Date(b.cita));
            
            if(citasFiltradas.length === 0) {
                msgSinCitas.style.display = 'block';
                msgSinCitas.textContent = 'No hay citas programadas para este per√≠odo';
                return;
            }
            
            msgSinCitas.style.display = 'none';
            
            // Agrupar por d√≠a
            const citasPorDia = {};
            citasFiltradas.forEach(cita => {
                const fecha = new Date(cita.cita);
                const fechaStr = fecha.toISOString().split('T')[0];
                
                if(!citasPorDia[fechaStr]) {
                    citasPorDia[fechaStr] = [];
                }
                citasPorDia[fechaStr].push(cita);
            });
            
            // Mostrar citas agrupadas por d√≠a
            Object.keys(citasPorDia).sort().forEach(fecha => {
                const divDia = document.createElement('div');
                divDia.className = 'calendar-day';
                divDia.innerHTML = `<strong>${formatearFecha(fecha)}</strong>`;
                listaCitas.appendChild(divDia);
                
                citasPorDia[fecha].forEach(cita => {
                    const ahora = new Date();
                    const fechaCita = new Date(cita.cita);
                    const diferenciaHoras = (fechaCita - ahora) / (1000 * 60 * 60);
                    
                    let claseUrgencia = '';
                    if(diferenciaHoras > 0 && diferenciaHoras <= 1) {
                        claseUrgencia = 'urgent';
                    } else if(diferenciaHoras > 1 && diferenciaHoras <= 24) {
                        claseUrgencia = 'upcoming';
                    }
                    
                    const divCita = document.createElement('div');
                    divCita.className = `calendar-appointment ${claseUrgencia}`;
                    divCita.innerHTML = `
                        <div style="font-weight:bold;">${cita.negocio}</div>
                        <div style="font-size:0.9em; color:#666;">${cita.encargado || 'Sin encargado'}</div>
                        <div style="font-size:0.9em; color:#666;">üìû ${cita.telefono || 'Sin tel√©fono'}</div>
                        <div style="font-size:0.9em; color:#666;">üìç ${cita.direccion || 'Sin direcci√≥n'}</div>
                        <div style="font-size:0.8em; color:#888;">‚è∞ ${fechaCita.toLocaleDateString('es-GT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                        <div style="margin-top:5px;">
                            ${cita.citaWhatsApp ? '<span style="color:#25D366; font-size:0.8em;">üì± WhatsApp</span>' : ''}
                            ${cita.citaLlamada ? '<span style="color:#4285F4; font-size:0.8em;">üìû Llamada</span>' : ''}
                            ${cita.citaOtro ? '<span style="color:#757575; font-size:0.8em;">üîò Otro</span>' : ''}
                        </div>
                        <div style="margin-top:5px;">
                            <button class="btn-icon" style="background:#00bcd4; font-size:11px;" onclick="window.open('https://www.google.com/maps/search/?api=1&query=${cita.lat||''},${cita.lng||''}','_blank')">üó∫Ô∏è</button>
                            <button class="btn-icon btn-warning" style="font-size:11px;" onclick="editar(${cita.id}); mostrar('view-form')">‚úèÔ∏è</button>
                            <button class="btn-icon btn-danger" style="font-size:11px;" onclick="borrarCita(${cita.id})">üóëÔ∏è</button>
                        </div>
                    `;
                    listaCitas.appendChild(divCita);
                });
            });
        }

        function borrarCita(id) {
            const cliente = db.find(x => x.id === id);
            if(!cliente) return;
            
            if(confirm(`¬øEliminar la cita de ${cliente.negocio}?\nFecha: ${cliente.cita ? cliente.cita.split('T')[0] : 'N/A'}`)) {
                cliente.cita = '';
                guardarDB();
                filtrarCitas();
                actualizarEstadisticas();
                actualizarBadgeCalendario();
                showToast('‚úÖ Cita eliminada', 'success');
                dispararAccionCritica(); // Disparar sincronizaci√≥n
            }
        }

        function formatearFecha(fechaStr) {
            const fecha = new Date(fechaStr);
            return fecha.toLocaleDateString('es-GT', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function formatearHora(fechaHoraStr) {
            const fecha = new Date(fechaHoraStr);
            return fecha.toLocaleTimeString('es-GT', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // --- SISTEMA DE NOTIFICACIONES ---
        function iniciarVerificacionRecordatorios() {
            notificacionInterval = setInterval(verificarRecordatorios, 60000);
        }

        function verificarRecordatorios() {
            const ahora = new Date();
            const dentroDe1Hora = new Date(ahora.getTime() + 60 * 60 * 1000);
            
            const citasProximas = db.filter(c => {
                if(!c.cita) return false;
                const fechaCita = new Date(c.cita);
                return fechaCita > ahora && fechaCita <= dentroDe1Hora;
            });
            
            citasProximas.forEach(cita => {
                mostrarNotificacion(cita);
                
                // Notificaci√≥n push si hay permisos
                if (notificationPermission) {
                    const tiempoRestante = Math.round((new Date(cita.cita) - ahora) / (1000 * 60));
                    mostrarNotificacionPush(
                        'üìÖ Recordatorio de Cita',
                        `${cita.negocio} - En ${tiempoRestante} minutos`,
                        { idCliente: cita.id }
                    );
                }
            });
        }

        function mostrarNotificacion(cita) {
            const modal = document.getElementById('notificationModal');
            const modalBody = document.getElementById('modalBody');
            
            const fechaCita = new Date(cita.cita);
            const tiempoRestante = Math.round((fechaCita - new Date()) / (1000 * 60));
            
            modalBody.innerHTML = `
                <div style="font-weight:bold; margin-bottom:5px;">${cita.negocio}</div>
                <div>${cita.encargado || 'Sin encargado'}</div>
                <div>üìû ${cita.telefono || 'Sin tel√©fono'}</div>
                <div>‚è∞ ${formatearHora(cita.cita)} (en ${tiempoRestante} minutos)</div>
                ${cita.direccion ? `<div>üìç ${cita.direccion}</div>` : ''}
                <div style="margin-top:10px; font-size:0.9em; color:#666;">
                    ${cita.citaWhatsApp ? 'üì± WhatsApp ‚Ä¢ ' : ''}
                    ${cita.citaLlamada ? 'üìû Llamada ‚Ä¢ ' : ''}
                    ${cita.citaOtro ? 'üîò Otro' : ''}
                </div>
            `;
            
            modal.style.display = 'flex';
            
            // Sonido de notificaci√≥n
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ');
                audio.play();
            } catch(e) {}
        }

        function cerrarModal() {
            document.getElementById('notificationModal').style.display = 'none';
        }

        function verCalendario() {
            cerrarModal();
            mostrar('view-calendar');
            filtrarCitasHoy();
        }

        // FUNCI√ìN PARA CARGAR DEPARTAMENTOS EN TODOS LOS SELECT
        function cargarDepartamentosEnSelects() {
            // Cargar en el formulario principal
            const selectDepto = document.getElementById('departamento');
            selectDepto.innerHTML = '<option value="">Seleccionar Departamento</option>';
            LISTA_DEPARTAMENTOS.forEach(depto => {
                const option = document.createElement('option');
                option.value = depto;
                option.textContent = depto;
                selectDepto.appendChild(option);
            });
            selectDepto.value = "Guatemala";

            // Cargar en el filtro del dashboard
            const filtroDash = document.getElementById('filtroDeptDash');
            filtroDash.innerHTML = '<option value="">Mostrar Todos</option>';
            
            // Agregar opci√≥n para m√∫ltiples departamentos
            const multipleOption = document.createElement('option');
            multipleOption.value = 'multiple';
            multipleOption.textContent = 'M√∫ltiples Departamentos';
            filtroDash.appendChild(multipleOption);
            
            LISTA_DEPARTAMENTOS.forEach(depto => {
                const option = document.createElement('option');
                option.value = depto;
                option.textContent = depto;
                filtroDash.appendChild(option);
            });

            // Cargar en el filtro de reportes
            const filtroReporte = document.getElementById('filtroDeptReporte');
            filtroReporte.innerHTML = '<option value="">Todo Depto</option>';
            LISTA_DEPARTAMENTOS.forEach(depto => {
                const option = document.createElement('option');
                option.value = depto;
                option.textContent = depto;
                filtroReporte.appendChild(option);
            });
            
            // Cargar municipios por defecto
            cargarMunicipiosPorDepartamento("Guatemala");
        }

        // Funci√≥n para cargar municipios seg√∫n departamento seleccionado
        function cargarMunicipiosPorDepartamento(depto) {
            const selectMunicipio = document.getElementById('municipio');
            selectMunicipio.innerHTML = '<option value="">Seleccionar Municipio</option>';
            
            if(depto && MUNICIPIOS_POR_DEPARTAMENTO[depto]) {
                MUNICIPIOS_POR_DEPARTAMENTO[depto].forEach(municipio => {
                    const option = document.createElement('option');
                    option.value = municipio;
                    option.textContent = municipio;
                    selectMunicipio.appendChild(option);
                });
            }
        }

        // --- FUNCIONES PARA DROPDOWN DE DEPARTAMENTOS CON CHECKBOXES ---
        function toggleDeptDropdown() {
            const dropdown = document.getElementById('deptDropdown');
            dropdown.classList.toggle('hidden');
            
            if (!dropdown.classList.contains('hidden')) {
                cargarCheckboxesDepartamentos();
            }
        }

        function cargarCheckboxesDepartamentos() {
            const container = document.querySelector('.dept-checkboxes-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            LISTA_DEPARTAMENTOS.forEach(depto => {
                const div = document.createElement('div');
                div.className = 'dept-checkbox-item';
                
                const checkboxId = `dept-checkbox-${depto.replace(/\s+/g, '-')}`;
                const isChecked = departamentosSeleccionados.includes(depto);
                
                div.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" value="${depto}" ${isChecked ? 'checked' : ''}>
                    <label for="${checkboxId}">${depto}</label>
                `;
                
                container.appendChild(div);
            });
        }

        function aplicarFiltroDepartamentos() {
            const checkboxes = document.querySelectorAll('.dept-checkboxes-container input[type="checkbox"]');
            departamentosSeleccionados = [];
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    departamentosSeleccionados.push(cb.value);
                }
            });
            
            // Guardar en localStorage
            localStorage.setItem('dept_seleccionados', JSON.stringify(departamentosSeleccionados));
            
            // Actualizar interfaz
            actualizarTextoBotonDepartamentos();
            
            // Cerrar dropdown
            document.getElementById('deptDropdown').classList.add('hidden');
            
            // Aplicar filtro en dashboard
            aplicarFiltroDepartamentosEnDashboard();
        }

        function limpiarFiltroDepartamentos() {
            departamentosSeleccionados = [];
            localStorage.removeItem('dept_seleccionados');
            
            // Desmarcar todos los checkboxes
            const checkboxes = document.querySelectorAll('.dept-checkboxes-container input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            
            // Actualizar interfaz
            actualizarTextoBotonDepartamentos();
            
            // Aplicar filtro en dashboard (que ser√° "mostrar todos")
            aplicarFiltroDepartamentosEnDashboard();
        }

        function actualizarTextoBotonDepartamentos() {
            const btn = document.querySelector('.dept-selector-header');
            if (!btn) return;
            
            if (departamentosSeleccionados.length === 0) {
                btn.innerHTML = 'üìã Filtrar Departamentos';
            } else if (departamentosSeleccionados.length === 1) {
                btn.innerHTML = `üìç ${departamentosSeleccionados[0]} <span class="dept-selected-badge">1</span>`;
            } else {
                btn.innerHTML = `üìç ${departamentosSeleccionados.length} Deptos <span class="dept-selected-badge">${departamentosSeleccionados.length}</span>`;
            }
        }

        function aplicarFiltroDepartamentosEnDashboard() {
            const selectDashboard = document.getElementById('filtroDeptDash');
            
            if (departamentosSeleccionados.length === 0) {
                // Mostrar todos
                selectDashboard.value = '';
            } else if (departamentosSeleccionados.length === 1) {
                // Seleccionar el √∫nico departamento
                selectDashboard.value = departamentosSeleccionados[0];
            } else {
                // Para m√∫ltiples departamentos, usamos la opci√≥n especial
                selectDashboard.value = 'multiple';
            }
            
            renderDashboard();
        }

        // --- NAVEGACI√ìN ---
        function mostrar(id) {
            document.querySelectorAll('.view-section').forEach(x => x.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
            
            if(id=='view-dashboard') {
                document.getElementById('btn-home').classList.add('active');
                renderDashboard();
                actualizarEstadisticas();
            }
            if(id=='view-ruta') { 
                document.getElementById('btn-ruta').classList.add('active'); 
                renderRuta(); 
            }
            if(id=='view-calendar') {
                document.getElementById('btn-cal').classList.add('active');
                document.getElementById('fechaCalendario').value = new Date().toISOString().split('T')[0];
                filtrarCitasHoy();
            }
            if(id=='view-form') document.getElementById('btn-add').classList.add('active');
            if(id=='view-reportes') {
                document.getElementById('btn-rep').classList.add('active');
            }
        }
        
        function volverConConfirmacion() {
            if (formDirty && !confirm("‚ö†Ô∏è Tienes cambios sin guardar. ¬øSeguro que quieres salir?")) {
                return;
            }
            formDirty = false;
            if(document.getElementById('flagRuta').value == '1') mostrar('view-ruta');
            else mostrar('view-dashboard');
        }
        
        function marcarFormularioModificado() {
            formDirty = true;
        }

        // --- VALIDACI√ìN DE TEL√âFONO ---
        function formatearTelefono(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.substring(0, 8);
            input.value = value;
            
            if(value.length >= 4) {
                const formatted = `${value.substring(0,4)} ${value.substring(4)}`;
                input.style.background = "#e8f5e9";
            } else {
                input.style.background = "";
            }
        }

        // --- DASHBOARD CON BUSCADOR ---
        function renderDashboard() {
            const list = document.getElementById('listaClientes');
            const filtroDepto = document.getElementById('filtroDeptDash').value;
            const busqueda = document.getElementById('buscadorDashboard').value.toLowerCase();
            const hoy = new Date().toISOString().split('T')[0];
            list.innerHTML = '';

            let data = [...db];
            
            // MODIFICACI√ìN AQU√ç: Manejar m√∫ltiples departamentos seleccionados
            if (filtroDepto === 'multiple' && departamentosSeleccionados.length > 0) {
                data = data.filter(c => departamentosSeleccionados.includes(c.departamento));
            } else if (filtroDepto && filtroDepto !== 'multiple') {
                data = data.filter(c => c.departamento === filtroDepto);
            }
            
            if(busqueda) {
                data = data.filter(c => 
                    (c.negocio && c.negocio.toLowerCase().includes(busqueda)) ||
                    (c.telefono && c.telefono.includes(busqueda)) ||
                    (c.encargado && c.encargado.toLowerCase().includes(busqueda)) ||
                    (c.direccion && c.direccion.toLowerCase().includes(busqueda))
                );
            }
            
            data.sort((a,b) => {
                if(a.departamento > b.departamento) return 1;
                if(a.departamento < b.departamento) return -1;
                if(a.negocio > b.negocio) return 1;
                if(a.negocio < b.negocio) return -1;
                return 0;
            });

            if(data.length === 0) { 
                document.getElementById('msgVacio').style.display='block'; 
                document.getElementById('msgVacio').textContent = busqueda ? 
                    'No se encontraron clientes que coincidan con la b√∫squeda.' : 
                    'No hay clientes registrados.';
                return; 
            }
            document.getElementById('msgVacio').style.display='none';

            data.forEach(c => {
                const enRuta = ruta.includes(c.id);
                const visitado = c.fecha === hoy;
                const mapLink = c.lat ? (c.lat==='MANUAL'?c.lng:`https://www.google.com/maps/search/?api=1&query=${c.lat},${c.lng}`) : null;

                const div = document.createElement('div');
                div.className = 'card';
                div.style.display = 'flex';
                div.innerHTML = `
                    <div style="padding-right:10px; display:flex; align-items:center;">
                        <input type="checkbox" class="check-ruta" onchange="toggleRuta(${c.id})" ${enRuta?'checked':''}>
                    </div>
                    <div style="flex-grow:1;">
                        <span class="tag-dept">${c.departamento}</span>
                        <div style="font-weight:bold; font-size:1.1em; color:#333; margin-top:2px;">${c.negocio}</div>
                        <div style="font-size:0.9em; color:#666;">${c.encargado}</div>
                        <div style="font-size:0.8em; color:#666;">üìû ${c.telefono || 'Sin tel√©fono'}</div>
                        ${c.municipio ? `<div style="font-size:0.8em; color:#666;">üìç ${c.municipio}</div>` : ''}
                        ${c.contactoWhatsApp ? '<span style="font-size:0.7em; color:#25D366; margin-right:5px;">üíö WhatsApp</span>' : ''}
                        ${c.contactoLlamada ? '<span style="font-size:0.7em; color:#4285F4; margin-right:5px;">üìû Llamada</span>' : ''}
                        ${c.contactoOtro ? '<span style="font-size:0.7em; color:#757575;">üîò Otro</span>' : ''}
                        ${visitado ? `<span class="tag-visited">‚úÖ GESTIONADO HOY</span>` : `<span style="font-size:0.8em; color:#999;">üìÖ √öltima gesti√≥n: ${c.fecha||'N/A'}</span>`}
                        ${c.cita ? `<div style="font-size:0.7em; color:#9c27b0; margin-top:3px;">üìÖ Cita: ${c.cita.split('T')[0]}</div>` : ''}
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px; justify-content:center; margin-left:5px;">
                        ${mapLink ? `<button class="btn-icon" style="background:#00bcd4;" onclick="window.open('${mapLink}','_blank')">üó∫Ô∏è</button>` : ''}
                        <button class="btn-icon btn-warning" onclick="editar(${c.id})">‚úèÔ∏è</button>
                        <button class="btn-icon btn-danger" onclick="confirmarBorrado(${c.id})">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(div);
            });
            actualizarBadge();
        }

        // --- RUTA CON OPTIMIZACI√ìN (MEJORADA) ---
        function toggleRuta(id) {
            const i = ruta.indexOf(id);
            if(i < 0) ruta.push(id); 
            else ruta.splice(i,1);
            rutaOptimizada = false;
            guardarDB();
            renderDashboard();
            actualizarBadge();
            if (!document.getElementById('view-ruta').classList.contains('hidden')) {
                renderRuta();
            }
        }
        
        function actualizarBadge() {
            const b = document.getElementById('badge');
            if(ruta.length>0) { 
                b.textContent=ruta.length; 
                b.classList.remove('hidden'); 
            } else {
                b.classList.add('hidden');
            }
        }
        
        function limpiarRuta() {
            const rutaActual = db.filter(c => ruta.includes(c.id));
            
            if(rutaActual.length === 0) {
                showToast("La ruta ya est√° vac√≠a", 'info');
                return;
            }
            
            if(confirm(`¬øEst√° seguro de eliminar ${rutaActual.length} cliente(s) de la ruta?\n\nEsta acci√≥n no se puede deshacer.`)) { 
                ruta = []; 
                rutaOptimizada = false;
                guardarDB(); 
                renderDashboard(); 
                renderRuta(); 
                actualizarBadge();
                showToast(`‚úÖ Ruta limpiada (${rutaActual.length} clientes eliminados)`, 'success');
                dispararAccionCritica(); // Disparar sincronizaci√≥n
            }
        }
        
        function calcularDistanciaHaversine(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Funci√≥n auxiliar para ordenar por proximidad cuando no hay GPS
        function ordenarPorProximidad(clientesConGPS) {
            if(clientesConGPS.length < 2) return;
            
            // Usar algoritmo de vecino m√°s cercano
            const visitados = new Set();
            const rutaOptimizadaIds = [];
            
            // Empezar con el primer cliente
            let actual = clientesConGPS[0];
            visitados.add(actual.id);
            rutaOptimizadaIds.push(actual.id);
            
            while(visitados.size < clientesConGPS.length) {
                let clienteMasCercano = null;
                let distanciaMinima = Infinity;
                
                for(const cliente of clientesConGPS) {
                    if(!visitados.has(cliente.id)) {
                        const distancia = calcularDistanciaHaversine(
                            parseFloat(actual.lat), parseFloat(actual.lng),
                            parseFloat(cliente.lat), parseFloat(cliente.lng)
                        );
                        
                        if(distancia < distanciaMinima) {
                            distanciaMinima = distancia;
                            clienteMasCercano = cliente;
                        }
                    }
                }
                
                if(clienteMasCercano) {
                    visitados.add(clienteMasCercano.id);
                    rutaOptimizadaIds.push(clienteMasCercano.id);
                    actual = clienteMasCercano;
                }
            }
            
            return rutaOptimizadaIds;
        }
        
        function optimizarRuta() {
            const items = db.filter(c => ruta.includes(c.id));
            
            if(items.length < 2) {
                showToast("Se necesitan al menos 2 clientes en la ruta", 'warning');
                return;
            }
            
            const clientesSinGPS = items.filter(c => !c.lat || c.lat === "MANUAL");
            const clientesConGPS = items.filter(c => c.lat && c.lat !== "MANUAL");
            
            if(clientesConGPS.length < 2) {
                showToast("Se necesitan al menos 2 clientes con GPS para optimizar", 'warning');
                return;
            }
            
            document.getElementById('gpsTxt').textContent = "Buscando ubicaci√≥n para optimizar...";
            
            // Intentar obtener ubicaci√≥n del dispositivo
            if(navigator.geolocation) {
                showLoading();
                navigator.geolocation.getCurrentPosition(
                    position => {
                        ubicacionActual = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        
                        localStorage.setItem('last_known_location', JSON.stringify(ubicacionActual));
                        
                        // Ordenar clientes con GPS por distancia desde la ubicaci√≥n actual
                        clientesConGPS.sort((a, b) => {
                            const distA = calcularDistanciaHaversine(
                                ubicacionActual.lat, ubicacionActual.lon,
                                parseFloat(a.lat), parseFloat(a.lng)
                            );
                            const distB = calcularDistanciaHaversine(
                                ubicacionActual.lat, ubicacionActual.lon,
                                parseFloat(b.lat), parseFloat(b.lng)
                            );
                            return distA - distB;
                        });
                        
                        // Crear nueva ruta optimizada
                        const nuevosIds = clientesConGPS.map(c => c.id);
                        const idsSinGPS = clientesSinGPS.map(c => c.id);
                        ruta = [...nuevosIds, ...idsSinGPS];
                        
                        rutaOptimizada = true;
                        guardarDB();
                        
                        hideLoading();
                        renderRuta();
                        showToast(`‚úÖ Ruta optimizada para ${clientesConGPS.length} clientes`, 'success');
                    },
                    error => {
                        hideLoading();
                        // Si no se puede obtener ubicaci√≥n, usar algoritmo de agrupaci√≥n por proximidad
                        const rutaOptimizadaIds = ordenarPorProximidad(clientesConGPS);
                        const idsSinGPS = clientesSinGPS.map(c => c.id);
                        ruta = [...rutaOptimizadaIds, ...idsSinGPS];
                        
                        rutaOptimizada = true;
                        guardarDB();
                        renderRuta();
                        showToast("‚ö†Ô∏è Optimizaci√≥n usando agrupaci√≥n por proximidad", 'info');
                    },
                    {enableHighAccuracy: true, timeout: 15000, maximumAge: 0}
                );
            } else {
                showToast("Navegador no soporta geolocalizaci√≥n", 'warning');
                const rutaOptimizadaIds = ordenarPorProximidad(clientesConGPS);
                const idsSinGPS = clientesSinGPS.map(c => c.id);
                ruta = [...rutaOptimizadaIds, ...idsSinGPS];
                
                rutaOptimizada = true;
                guardarDB();
                renderRuta();
            }
        }
        
        function renderRuta() {
            const con = document.getElementById('listaRutaContainer'); 
            const rutaInfo = document.getElementById('rutaInfo');
            const distanciaTotalElem = document.getElementById('distanciaTotal');
            con.innerHTML='';
            
            const items = db.filter(c => ruta.includes(c.id));
            
            if(items.length===0) { 
                con.innerHTML='<p style="text-align:center; padding:20px; color:#777;">No hay clientes en la ruta.</p>'; 
                rutaInfo.textContent = '0 clientes en ruta';
                distanciaTotalElem.textContent = '';
                return; 
            }
            
            rutaInfo.textContent = `${items.length} cliente(s) en ruta`;
            
            let distanciaTotal = 0;
            if(rutaOptimizada && items.length > 1) {
                for(let i = 0; i < items.length - 1; i++) {
                    const clienteActual = items[i];
                    const clienteSiguiente = items[i + 1];
                    
                    if(clienteActual.lat && clienteActual.lat !== "MANUAL" &&
                       clienteSiguiente.lat && clienteSiguiente.lat !== "MANUAL") {
                        distanciaTotal += calcularDistanciaHaversine(
                            parseFloat(clienteActual.lat), parseFloat(clienteActual.lng),
                            parseFloat(clienteSiguiente.lat), parseFloat(clienteSiguiente.lng)
                        );
                    }
                }
                
                if(distanciaTotal > 0) {
                    distanciaTotalElem.textContent = `üìè Distancia total: ${distanciaTotal.toFixed(1)} km`;
                } else {
                    distanciaTotalElem.textContent = '';
                }
            } else {
                distanciaTotalElem.textContent = '';
            }
            
            items.forEach((c, index) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.borderLeft = '5px solid #1976d2';
                div.style.marginTop = '5px';
                
                if(rutaOptimizada) {
                    div.classList.add('route-optimized');
                }
                
                let infoDistancia = '';
                if(rutaOptimizada && index > 0 && items[index-1].lat && items[index-1].lat !== "MANUAL" &&
                   c.lat && c.lat !== "MANUAL") {
                    const distancia = calcularDistanciaHaversine(
                        parseFloat(items[index-1].lat), parseFloat(items[index-1].lng),
                        parseFloat(c.lat), parseFloat(c.lng)
                    );
                    infoDistancia = `<span class="route-distance">(${distancia.toFixed(1)} km desde anterior)</span>`;
                }
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div style="font-weight: bold; font-size: 1.1em;">${index + 1}. ${c.negocio}</div>
                            <div style="font-size: 0.9em; color: #666;">${c.direccion || 'Sin direcci√≥n'}</div>
                            ${c.municipio ? `<div style="font-size: 0.9em; color: #666;">üìç ${c.municipio}</div>` : ''}
                            <div style="margin-top: 5px;">
                                <span class="tag-dept">${c.departamento}</span>
                                ${infoDistancia}
                            </div>
                            <div style="margin-top: 5px; font-size: 0.8em;">
                                ${c.contactoWhatsApp ? '<span style="color:#25D366; margin-right:10px;">üíö WhatsApp</span>' : ''}
                                ${c.contactoLlamada ? '<span style="color:#4285F4; margin-right:10px;">üìû Llamada</span>' : ''}
                                ${c.contactoOtro ? '<span style="color:#757575;">üîò Otro</span>' : ''}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button class="btn-icon btn-danger" onclick="toggleRuta(${c.id}); renderRuta();" style="font-size:12px;">‚úï</button>
                            ${c.lat && c.lat !== "MANUAL" ? 
                                `<button class="btn-icon" style="background:#00bcd4; font-size:12px;" onclick="window.open('https://www.google.com/maps/search/?api=1&query=${c.lat},${c.lng}','_blank')">üó∫Ô∏è</button>` : 
                                ''
                            }
                        </div>
                    </div>
                    <div style="margin-top:10px; display:flex; justify-content:space-between;">
                        <button class="btn-secondary" style="padding:8px 12px; border:none; border-radius:4px; color:white; font-size:14px;" onclick="toggleRuta(${c.id}); renderRuta();">Descartar</button>
                        <button class="btn-success" style="padding:8px 12px; border:none; border-radius:4px; color:white; font-size:14px; font-weight:bold;" onclick="gestionar(${c.id})">‚úÖ Gestionar Visita</button>
                    </div>
                `;
                con.appendChild(div);
            });
        }
        
        function abrirMapaRuta() {
            const items = db.filter(c => ruta.includes(c.id) && c.lat && c.lat !== "MANUAL");
            if(items.length===0) {
                showToast("Agrega clientes con GPS a la ruta primero", 'warning');
                return;
            }
            
            let url = "https://www.google.com/maps/dir/";
            
            const lastLoc = localStorage.getItem('last_known_location');
            if(lastLoc) {
                const loc = JSON.parse(lastLoc);
                url += `${loc.lat},${loc.lon}/`;
            }
            
            items.forEach((c, i) => {
                if(i > 0 || lastLoc) url += '/';
                url += `${c.lat},${c.lng}`;
            });
            
            window.open(url, '_blank');
        }

        // --- CRUD (AGREGAR/EDITAR) ---
        function nuevoCliente() { 
            if (formDirty && !confirm("‚ö†Ô∏è Tienes cambios sin guardar en el formulario actual. ¬øContinuar?")) {
                return;
            }
            limpiarForm(); 
            document.getElementById('tituloForm').textContent="Nuevo Cliente"; 
            document.getElementById('btnFin').textContent="üíæ GUARDAR"; 
            mostrar('view-form'); 
        }
        
        function editar(id) { 
            if (formDirty && !confirm("‚ö†Ô∏è Tienes cambios sin guardar. ¬øContinuar?")) {
                return;
            }
            cargarForm(id); 
            document.getElementById('tituloForm').textContent="Editar Cliente"; 
            document.getElementById('btnFin').textContent="üíæ ACTUALIZAR"; 
            mostrar('view-form'); 
        }
        
        function gestionar(id) { 
            cargarForm(id); 
            document.getElementById('flagRuta').value="1"; 
            document.getElementById('tituloForm').textContent="Gestionando Visita"; 
            document.getElementById('btnFin').textContent="‚úÖ FINALIZAR GESTI√ìN"; 
            mostrar('view-form'); 
        }

        function cargarForm(id) {
            const c = db.find(x => x.id === id);
            if(!c) return;
            
            document.getElementById('idCliente').value = c.id;
            document.getElementById('negocio').value = c.negocio || '';
            document.getElementById('departamento').value = c.departamento || 'Guatemala';
            document.getElementById('direccion').value = c.direccion || '';
            document.getElementById('encargado').value = c.encargado || '';
            document.getElementById('telefono').value = c.telefono || '';
            document.getElementById('cita').value = c.cita || '';
            document.getElementById('lat').value = c.lat || '';
            document.getElementById('lng').value = c.lng || '';
            document.getElementById('mensajeWhatsApp').value = c.mensajeWhatsApp || '';
            
            document.getElementById('contactoWhatsApp').checked = c.contactoWhatsApp || false;
            document.getElementById('contactoLlamada').checked = c.contactoLlamada || false;
            document.getElementById('contactoOtro').checked = c.contactoOtro || false;
            
            document.getElementById('citaWhatsApp').checked = c.citaWhatsApp || false;
            document.getElementById('citaLlamada').checked = c.citaLlamada || false;
            document.getElementById('citaOtro').checked = c.citaOtro || false;
            
            document.getElementById('gpsTxt').textContent = c.lat ? "‚úÖ GPS Guardado" : "Sin GPS";
            
            // Cargar municipio
            cargarMunicipiosPorDepartamento(c.departamento);
            if(c.municipio) {
                document.getElementById('municipio').value = c.municipio;
            }
            
            formDirty = false;
        }
        
        function limpiarForm() {
            document.getElementById('idCliente').value = '';
            document.getElementById('negocio').value = '';
            document.getElementById('departamento').value = 'Guatemala';
            document.getElementById('direccion').value = '';
            document.getElementById('encargado').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('cita').value = '';
            document.getElementById('lat').value = '';
            document.getElementById('lng').value = '';
            document.getElementById('mensajeWhatsApp').value = '';
            document.getElementById('flagRuta').value = '0';
            document.getElementById('gpsTxt').textContent = "Esperando...";
            document.getElementById('boxManual').classList.add('hidden');
            document.getElementById('linkMan').value = '';
            document.getElementById('foto').value = '';
            
            document.getElementById('contactoWhatsApp').checked = false;
            document.getElementById('contactoLlamada').checked = false;
            document.getElementById('contactoOtro').checked = false;
            
            document.getElementById('citaWhatsApp').checked = false;
            document.getElementById('citaLlamada').checked = false;
            document.getElementById('citaOtro').checked = false;
            
            // Limpiar municipio
            cargarMunicipiosPorDepartamento('Guatemala');
            
            formDirty = false;
        }
        
        async function confirmarBorrado(id) {
            const cliente = db.find(x => x.id === id);
            if(!cliente) return;
            
            const nombre = cliente.negocio;
            const telefono = cliente.telefono || '';
            
            if(await confirmarEliminacion(id, nombre)) {
                db = db.filter(x => x.id !== id); 
                ruta = ruta.filter(x => x !== id);
                guardarDB(); 
                renderDashboard();
                actualizarEstadisticas();
                actualizarBadgeCalendario();
                if (!document.getElementById('view-reportes').classList.contains('hidden')) {
                    regenerarReporteActual();
                }
                if (!document.getElementById('view-calendar').classList.contains('hidden')) {
                    filtrarCitas();
                }
                showToast(`‚úÖ Cliente "${nombre}" eliminado`, 'success');
                dispararAccionCritica(); // Disparar sincronizaci√≥n
            }
        }
        
        async function confirmarEliminacion(id, nombre = "") {
            return new Promise((resolve) => {
                if(confirm(`¬øEliminar ${nombre ? 'a "' + nombre + '"' : 'este cliente'} permanentemente?\n\nEsta acci√≥n no se puede deshacer.`)) {
                    resolve(true);
                } else {
                    resolve(false);
                }
            });
        }
        
        function irGPS() {
            const telefono = document.getElementById('telefono').value.trim();
            const negocio = document.getElementById('negocio').value.trim();
            
            if(!negocio) {
                showToast("El nombre del negocio es obligatorio", 'error');
                return;
            }
            if(!telefono) {
                showToast("El n√∫mero de tel√©fono es obligatorio", 'error');
                return;
            }
            if(telefono.length !== 8) {
                showToast("El tel√©fono debe tener 8 d√≠gitos", 'error');
                return;
            }
            if(!/^\d+$/.test(telefono)) {
                showToast("El tel√©fono solo debe contener n√∫meros", 'error');
                return;
            }
            
            // Verificar duplicados
            const idActual = parseInt(document.getElementById('idCliente').value);
            const duplicado = db.find(c => c.telefono === telefono && c.id !== idActual);
            if(duplicado && !confirm(`‚ö†Ô∏è Este tel√©fono ya est√° registrado para: ${duplicado.negocio}\n\n¬øContinuar de todos modos?`)) {
                return;
            }
            
            mostrar('view-gps');
        }
        
        function obtenerGPS() {
            const s = document.getElementById('gpsTxt'); 
            s.textContent = "Buscando GPS...";
            
            if(!navigator.geolocation) { 
                s.textContent = "‚ùå GPS no soportado en este navegador"; 
                document.getElementById('boxManual').classList.remove('hidden'); 
                return; 
            }
            
            let timeoutId = setTimeout(() => {
                s.textContent = "‚è±Ô∏è Tiempo agotado. Usando ubicaci√≥n aproximada...";
                const lastLat = localStorage.getItem('last_lat');
                const lastLng = localStorage.getItem('last_lng');
                if(lastLat && lastLng) {
                    document.getElementById('lat').value = lastLat;
                    document.getElementById('lng').value = lastLng;
                    s.textContent = "üìç Usando √∫ltima ubicaci√≥n conocida";
                } else {
                    document.getElementById('boxManual').classList.remove('hidden');
                }
            }, 10000);
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    clearTimeout(timeoutId);
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    if(lat < 13.5 || lat > 17.8 || lng < -92.3 || lng > -88.2) {
                        s.textContent = "‚ö†Ô∏è Coordenadas fuera de Guatemala. Verificar.";
                        document.getElementById('lat').value = lat;
                        document.getElementById('lng').value = lng;
                        return;
                    }
                    
                    document.getElementById('lat').value = lat;
                    document.getElementById('lng').value = lng;
                    s.textContent = `‚úÖ GPS: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    
                    localStorage.setItem('last_lat', lat);
                    localStorage.setItem('last_lng', lng);
                }, 
                error => { 
                    clearTimeout(timeoutId);
                    let mensaje = "‚ùå ";
                    switch(error.code) {
                        case 1: mensaje += "Permiso denegado"; break;
                        case 2: mensaje += "Ubicaci√≥n no disponible"; break;
                        case 3: mensaje += "Tiempo agotado"; break;
                        default: mensaje += error.message;
                    }
                    s.textContent = mensaje; 
                    document.getElementById('boxManual').classList.remove('hidden'); 
                }, 
                {enableHighAccuracy: true, timeout: 8000, maximumAge: 30000}
            );
        }
        
        function usarManual() {
            const link = document.getElementById('linkMan').value;
            if(link) { 
                document.getElementById('lat').value = "MANUAL"; 
                document.getElementById('lng').value = link; 
                document.getElementById('gpsTxt').textContent = "‚úÖ Link guardado"; 
                showToast("‚úÖ Link de ubicaci√≥n guardado", 'success');
            }
        }
        
        // --- FOTO ---
        document.getElementById('foto').addEventListener('change', function(e){
            if(e.target.files[0]) {
                const depto = document.getElementById('departamento').value.toUpperCase().replace(/\s/g,'_');
                const negocio = document.getElementById('negocio').value.replace(/[^a-z0-9]/gi, '_').substring(0, 20);
                const fecha = new Date().toISOString().slice(0,10).replace(/-/g, '');
                const hora = new Date().toTimeString().slice(0,8).replace(/:/g, '');
                
                const a = document.createElement('a');
                a.href = URL.createObjectURL(e.target.files[0]);
                a.download = `${depto}_${negocio}_${fecha}_${hora}.jpg`;
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a);
                
                showToast("‚úÖ Foto descargada exitosamente", 'success');
            }
        });

        // --- GUARDAR ---
        function guardar() {
            const id = document.getElementById('idCliente').value;
            const nuevoId = id ? parseInt(id) : Date.now();
            const telefono = document.getElementById('telefono').value.trim();
            const negocio = sanitizeInput(document.getElementById('negocio').value);
            
            // Validaciones
            if(!negocio) {
                showToast("El nombre del negocio es obligatorio", 'error');
                return;
            }
            if(!document.getElementById('departamento').value) {
                showToast("Debe seleccionar un departamento", 'error');
                return;
            }
            if(!telefono) {
                showToast("El n√∫mero de tel√©fono es obligatorio", 'error');
                return;
            }
            if(telefono.length !== 8) {
                showToast("El n√∫mero de tel√©fono debe tener 8 d√≠gitos", 'error');
                return;
            }
            if(!/^\d+$/.test(telefono)) {
                showToast("El n√∫mero de tel√©fono solo debe contener d√≠gitos", 'error');
                return;
            }
            
            const data = {
                id: nuevoId,
                negocio: negocio,
                departamento: document.getElementById('departamento').value,
                municipio: document.getElementById('municipio').value,
                direccion: sanitizeInput(document.getElementById('direccion').value),
                encargado: sanitizeInput(document.getElementById('encargado').value),
                telefono: telefono,
                cita: document.getElementById('cita').value,
                lat: document.getElementById('lat').value,
                lng: document.getElementById('lng').value,
                mensajeWhatsApp: sanitizeInput(document.getElementById('mensajeWhatsApp').value),
                contactoWhatsApp: document.getElementById('contactoWhatsApp').checked,
                contactoLlamada: document.getElementById('contactoLlamada').checked,
                contactoOtro: document.getElementById('contactoOtro').checked,
                citaWhatsApp: document.getElementById('citaWhatsApp').checked,
                citaLlamada: document.getElementById('citaLlamada').checked,
                citaOtro: document.getElementById('citaOtro').checked,
                fecha: new Date().toISOString().split('T')[0],
                ultimaModificacion: new Date().toISOString()
            };

            const idx = db.findIndex(x => x.id === nuevoId);
            if(idx >= 0) {
                db[idx] = data;
            } else {
                db.push(data);
            }

            if(document.getElementById('flagRuta').value === "1") {
                const ri = ruta.indexOf(nuevoId);
                if(ri >= 0) ruta.splice(ri, 1);
            }

            guardarDB();
            showToast(idx >= 0 ? "‚úÖ Cliente actualizado" : "‚úÖ Cliente guardado", 'success');
            limpiarForm();
            mostrar('view-dashboard');
            renderDashboard();
            actualizarEstadisticas();
            actualizarBadgeCalendario();
            dispararAccionCritica(); // Disparar sincronizaci√≥n autom√°tica
        }
        
        function guardarDB() { 
            try {
                localStorage.setItem('db_clientes_v9', JSON.stringify(db)); 
                localStorage.setItem('db_ruta_v9', JSON.stringify(ruta)); 
                crearBackupAutomatico();
            } catch(e) {
                showToast("‚ùå Error al guardar: " + e.message, 'error');
                console.error("Error al guardar:", e);
            }
        }

        // --- VERIFICACI√ìN DE INTEGRIDAD DE DATOS ---
        function verificarIntegridadDatos() {
            const errores = [];
            
            db.forEach((cliente, index) => {
                if(!cliente.id) errores.push(`Cliente ${index}: Sin ID`);
                if(!cliente.negocio) errores.push(`Cliente ${index}: Sin nombre de negocio`);
                if(cliente.telefono && !/^[0-9]{8}$/.test(cliente.telefono)) {
                    errores.push(`Cliente ${index}: Tel√©fono inv√°lido (${cliente.telefono})`);
                }
                
                if(cliente.lat && cliente.lat !== "MANUAL") {
                    const lat = parseFloat(cliente.lat);
                    const lng = parseFloat(cliente.lng);
                    if(isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                        errores.push(`Cliente ${index}: Coordenadas inv√°lidas`);
                    }
                }
            });
            
            const telefonos = db.map(c => c.telefono).filter(t => t);
            const duplicados = telefonos.filter((t, i) => telefonos.indexOf(t) !== i);
            if(duplicados.length > 0) {
                console.warn(`Tel√©fonos duplicados: ${[...new Set(duplicados)].join(', ')}`);
            }
            
            if(errores.length > 0) {
                console.warn("Problemas de integridad encontrados:", errores);
                if(errores.length > 10) {
                    showToast("‚ö†Ô∏è Se encontraron problemas en la base de datos", 'warning');
                }
            }
            
            return errores;
        }

        // --- REPORTES CON EXPORTACI√ìN CSV ---
        function reporteDiario() {
            const hoy = new Date().toISOString().split('T')[0];
            filtrosReporteActual = { tipo: 'diario', fecha: hoy, depto: null };
            generarTablaReporte(hoy, null, "REPORTE DE VISITAS DEL D√çA", `Fecha: ${hoy}`);
        }
        
        function reporteTotal() {
            filtrosReporteActual = { tipo: 'total', fecha: null, depto: null };
            generarTablaReporte(null, null, "CARTERA TOTAL DE CLIENTES", "Listado completo ordenado por departamento");
        }
        
        function reporteCustom() {
            const f = document.getElementById('repFecha').value;
            const d = document.getElementById('filtroDeptReporte').value;
            filtrosReporteActual = { tipo: 'custom', fecha: f, depto: d };
            generarTablaReporte(f, d, "REPORTE PERSONALIZADO", `Filtros: ${f || 'Cualquier fecha'} - ${d || 'Todos los departamentos'}`);
        }

        function generarTablaReporte(fechaFiltro, deptFiltro, titulo, subtitulo) {
            const tbody = document.querySelector('#tablaRep tbody');
            tbody.innerHTML = '';
            document.getElementById('tituloReporte').textContent = titulo;
            document.getElementById('subtituloReporte').textContent = subtitulo;

            let datos = [...db];
            
            if(fechaFiltro) datos = datos.filter(c => c.fecha === fechaFiltro);
            if(deptFiltro) datos = datos.filter(c => c.departamento === deptFiltro);
            
            datos.sort((a,b) => {
                if(a.departamento > b.departamento) return 1;
                if(a.departamento < b.departamento) return -1;
                if(a.negocio > b.negocio) return 1;
                if(a.negocio < b.negocio) return -1;
                return 0;
            });

            if(datos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No se encontraron registros.</td></tr>';
                document.getElementById('resumenReporte').textContent = "Total: 0 registros";
                return;
            }

            const agrupados = {};
            datos.forEach(c => {
                if(!agrupados[c.departamento]) {
                    agrupados[c.departamento] = [];
                }
                agrupados[c.departamento].push(c);
            });

            Object.keys(agrupados).sort().forEach(depto => {
                tbody.innerHTML += `
                    <tr style="background:#e3f2fd;">
                        <td colspan="5" style="font-weight:bold; color:#1565c0; text-transform:uppercase;">
                            üìç ${depto} (${agrupados[depto].length} clientes)
                        </td>
                    </tr>
                `;
                
                agrupados[depto].forEach(c => {
                    const opcionesContacto = [];
                    if(c.contactoWhatsApp) opcionesContacto.push('WhatsApp');
                    if(c.contactoLlamada) opcionesContacto.push('Llamada');
                    if(c.contactoOtro) opcionesContacto.push('Otro');
                    
                    const opcionesCita = [];
                    if(c.citaWhatsApp) opcionesCita.push('WhatsApp');
                    if(c.citaLlamada) opcionesCita.push('Llamada');
                    if(c.citaOtro) opcionesCita.push('Otro');
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <b>${c.negocio}</b><br>
                                <small>üë§ ${c.encargado || 'Sin encargado'}</small><br>
                                <small>ID: ${c.id}</small>
                            </td>
                            <td>
                                ${c.municipio ? `${c.municipio}<br>` : ''}
                                ${c.direccion || 'Sin direcci√≥n'}<br>
                                <small>üìû ${c.telefono || 'Sin tel√©fono'}</small>
                            </td>
                            <td>
                                <small><b>Contacto:</b> ${opcionesContacto.length > 0 ? opcionesContacto.join(' ‚Ä¢ ') : 'No especificado'}</small><br>
                                <small><b>Recordatorio:</b> ${opcionesCita.length > 0 ? opcionesCita.join(' ‚Ä¢ ') : 'No especificado'}</small>
                                ${c.mensajeWhatsApp ? `<br><small><b>Mensaje:</b> ${c.mensajeWhatsApp}</small>` : ''}
                            </td>
                            <td>
                                üìÖ ${c.fecha || 'Sin fecha'}<br>
                                <small>${c.cita ? '‚è∞ Cita: ' + c.cita.replace('T', ' ') : 'Sin cita'}</small>
                            </td>
                            <td class="no-print">
                                <button class="btn-icon btn-danger" onclick="eliminarDesdeReporte(${c.id})">üóëÔ∏è</button>
                                <button class="btn-icon btn-warning" onclick="editar(${c.id}); mostrar('view-form')">‚úèÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            });
            
            document.getElementById('resumenReporte').textContent = 
                `Total: ${datos.length} cliente(s) | Departamentos: ${Object.keys(agrupados).length}`;
        }
        
        async function eliminarDesdeReporte(id) {
            const cliente = db.find(x => x.id === id);
            if(!cliente) return;
            
            if(await confirmarEliminacion(id, cliente.negocio)) {
                db = db.filter(x => x.id !== id);
                ruta = ruta.filter(x => x !== id);
                guardarDB();
                renderDashboard();
                actualizarEstadisticas();
                actualizarBadgeCalendario();
                regenerarReporteActual();
                showToast(`‚úÖ Cliente eliminado del reporte`, 'success');
                dispararAccionCritica(); // Disparar sincronizaci√≥n
            }
        }
        
        function eliminarTodosDelReporte() {
            if(db.length === 0) {
                showToast("No hay clientes para eliminar", 'info');
                return;
            }
            
            // Determinar qu√© clientes est√°n en el reporte actual
            let clientesAEliminar = [...db];
            
            if(filtrosReporteActual.fecha) {
                clientesAEliminar = clientesAEliminar.filter(c => c.fecha === filtrosReporteActual.fecha);
            }
            if(filtrosReporteActual.depto) {
                clientesAEliminar = clientesAEliminar.filter(c => c.departamento === filtrosReporteActual.depto);
            }
            
            if(clientesAEliminar.length === 0) {
                showToast("No hay clientes que coincidan con los filtros actuales", 'info');
                return;
            }
            
            const confirmacion = prompt(`¬øEst√° seguro de eliminar TODOS los clientes? Esta acci√≥n no se puede deshacer.\n\nEscriba "ELIMINAR" para confirmar:`);
            
            if(confirmacion === "ELIMINAR") {
                if(confirm(`‚ö†Ô∏è ADVERTENCIA FINAL\n\nSe eliminar√°n ${clientesAEliminar.length} cliente(s) permanentemente.\n\n¬øContinuar?`)) {
                    const idsAEliminar = clientesAEliminar.map(c => c.id);
                    db = db.filter(c => !idsAEliminar.includes(c.id));
                    ruta = ruta.filter(id => !idsAEliminar.includes(id));
                    
                    guardarDB();
                    showToast(`‚úÖ Se eliminaron ${clientesAEliminar.length} cliente(s) exitosamente`, 'success');
                    renderDashboard();
                    actualizarEstadisticas();
                    actualizarBadgeCalendario();
                    regenerarReporteActual();
                    dispararAccionCritica(); // Disparar sincronizaci√≥n
                }
            } else {
                showToast("Eliminaci√≥n cancelada", 'info');
            }
        }
        
        function regenerarReporteActual() {
            switch(filtrosReporteActual.tipo) {
                case 'diario':
                    reporteDiario();
                    break;
                case 'total':
                    reporteTotal();
                    break;
                case 'custom':
                    reporteCustom();
                    break;
                default:
                    reporteTotal();
            }
        }
        
        // --- EXPORTACI√ìN A CSV ---
        function exportarCSV() {
            let datos = [...db];
            
            if(filtrosReporteActual.fecha) {
                datos = datos.filter(c => c.fecha === filtrosReporteActual.fecha);
            }
            if(filtrosReporteActual.depto) {
                datos = datos.filter(c => c.departamento === filtrosReporteActual.depto);
            }
            
            if(datos.length === 0) {
                showToast("No hay datos para exportar", 'warning');
                return;
            }
            
            datos.sort((a,b) => {
                if(a.departamento > b.departamento) return 1;
                if(a.departamento < b.departamento) return -1;
                if(a.negocio > b.negocio) return 1;
                if(a.negocio < b.negocio) return -1;
                return 0;
            });
            
            const headers = [
                'ID',
                'Negocio',
                'Departamento',
                'Municipio',
                'Direcci√≥n',
                'Encargado',
                'Tel√©fono',
                'Contacto WhatsApp',
                'Contacto Llamada',
                'Contacto Otro',
                'Mensaje WhatsApp',
                '√öltima Visita',
                'Pr√≥xima Cita',
                'Recordatorio WhatsApp',
                'Recordatorio Llamada',
                'Recordatorio Otro',
                'Latitud',
                'Longitud'
            ];
            
            const rows = datos.map(c => {
                return [
                    c.id,
                    `"${(c.negocio || '').replace(/"/g, '""')}"`,
                    `"${(c.departamento || '').replace(/"/g, '""')}"`,
                    `"${(c.municipio || '').replace(/"/g, '""')}"`,
                    `"${(c.direccion || '').replace(/"/g, '""')}"`,
                    `"${(c.encargado || '').replace(/"/g, '""')}"`,
                    c.telefono || '',
                    c.contactoWhatsApp ? 'SI' : 'NO',
                    c.contactoLlamada ? 'SI' : 'NO',
                    c.contactoOtro ? 'SI' : 'NO',
                    `"${(c.mensajeWhatsApp || '').replace(/"/g, '""')}"`,
                    c.fecha || '',
                    c.cita ? c.cita.replace('T', ' ') : '',
                    c.citaWhatsApp ? 'SI' : 'NO',
                    c.citaLlamada ? 'SI' : 'NO',
                    c.citaOtro ? 'SI' : 'NO',
                    c.lat || '',
                    c.lng || ''
                ].join(',');
            });
            
            const csvContent = [headers.join(','), ...rows].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            let filename = 'reporte_clientes';
            if(filtrosReporteActual.tipo === 'diario') {
                filename = `visitas_${new Date().toISOString().split('T')[0]}`;
            } else if(filtrosReporteActual.tipo === 'custom' && filtrosReporteActual.depto) {
                filename = `clientes_${filtrosReporteActual.depto.replace(/\s+/g, '_')}`;
            }
            
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast(`‚úÖ Se exportaron ${datos.length} registros a CSV`, 'success');
        }
        
        function agendarCal() {
            const n = document.getElementById('negocio').value;
            const c = document.getElementById('cita').value;
            if(!c) {
                showToast("Seleccione fecha y hora para la cita", 'warning');
                return;
            }
            
            const fecha = new Date(c);
            const inicio = fecha.toISOString().replace(/-|:|\.\d\d\d/g,"");
            const fin = new Date(fecha.getTime() + 60*60*1000).toISOString().replace(/-|:|\.\d\d\d/g,"");
            
            window.open(
                `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(n)}&dates=${inicio}/${fin}`,
                '_blank'
            );
        }

        // --- FUNCIONES DE SINCRONIZACI√ìN (NUBE) ---
        function sincronizarDrive() {
            // 1. Validaciones b√°sicas
            if(db.length === 0) {
                showToast("No hay datos para sincronizar", "warning");
                return;
            }
            if(!navigator.onLine) {
                showToast("‚ö†Ô∏è Necesitas internet para sincronizar", "error");
                return;
            }
            if(!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes("TU-URL")) {
                showToast("‚ö†Ô∏è Error en configuraci√≥n del Servidor (URL)", "error");
                return;
            }

            // 2. Respaldo de seguridad OBLIGATORIO antes de tocar nada
            realizarBackupManual(); 

            // 3. UI Feedback
            showToast("‚òÅÔ∏è Subiendo datos a Google Sheets...", "info");
            const btnSync = event.target;
            const textoOriginal = btnSync.textContent;
            btnSync.textContent = "‚è≥ Subiendo...";
            btnSync.disabled = true;

            // 4. Enviar datos
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors", // Necesario para evitar bloqueos simples de Apps Script
                headers: {
                    "Content-Type": "text/plain;charset=utf-8" // Truco para evitar Preflight CORS
                },
                body: JSON.stringify(db)
            })
            .then(response => {
                // Al usar no-cors, la respuesta es opaca. Asumimos √©xito si no hay error de red.
                showToast("‚úÖ ¬°Datos enviados a la Nube exitosamente!", "success");
                btnSync.textContent = textoOriginal;
                btnSync.disabled = false;
                
                // Actualizar √∫ltima sincronizaci√≥n
                const now = new Date();
                lastSyncTime = now.toISOString();
                localStorage.setItem('last_sync_time', lastSyncTime);
                actualizarIndicadorSincronizacion();
            })
            .catch(error => {
                console.error("Error:", error);
                showToast("‚ùå Error de conexi√≥n al subir", "error");
                btnSync.textContent = textoOriginal;
                btnSync.disabled = false;
            });
        }

        async function descargarDeDrive() {
            if(!navigator.onLine) {
                showToast("‚ö†Ô∏è Necesitas internet para descargar", "error");
                return;
            }

            // 1. Confirmaci√≥n de seguridad
            if(!confirm("‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n REEMPLAZAR√Å todos los datos de este dispositivo con los de la Nube.\n\nSe descargar√° un respaldo de seguridad autom√°tico antes de proceder.\n\n¬øEst√°s seguro?")) {
                return;
            }

            // 2. Respaldo de seguridad OBLIGATORIO
            realizarBackupManual();

            // 3. UI Feedback
            showToast("‚è≥ Conectando con Google Sheets...", "info");
            const btnSync = event.target;
            const textoOriginal = btnSync.textContent;
            btnSync.textContent = "‚è≥ Descargando...";
            btnSync.disabled = true;
            
            try {
                // 4. Descargar datos (GET)
                const response = await fetch(GOOGLE_SCRIPT_URL);
                
                if (!response.ok) throw new Error('Error en la red');
                
                const dataNube = await response.json();
                
                if(dataNube && Array.isArray(dataNube)) {
                    if(dataNube.length > 0) {
                        // Reemplazamos la base de datos local
                        db = dataNube;
                        guardarDB(); // Guarda en localStorage
                        
                        // Actualizar √∫ltima sincronizaci√≥n
                        const now = new Date();
                        lastSyncTime = now.toISOString();
                        localStorage.setItem('last_sync_time', lastSyncTime);
                        actualizarIndicadorSincronizacion();
                        
                        // Refrescamos la pantalla
                        renderDashboard();
                        actualizarEstadisticas();
                        actualizarBadgeCalendario();
                        
                        showToast(`‚úÖ Se restauraron ${db.length} clientes desde la Nube`, "success");
                    } else {
                        showToast("‚ö†Ô∏è La base de datos en la nube est√° vac√≠a", "warning");
                    }
                } else {
                    throw new Error("Formato de datos incorrecto");
                }
            } catch (error) {
                console.error("Error:", error);
                showToast("‚ùå Error al descargar. Verifica tu internet.", "error");
            } finally {
                btnSync.textContent = textoOriginal;
                btnSync.disabled = false;
            }
        }
    </script>
</body>
</html>
